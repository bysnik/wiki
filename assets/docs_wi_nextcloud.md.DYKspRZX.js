import{_ as s,c as e,o as n,ag as t}from"./chunks/framework.D4Vqf8I7.js";const u=JSON.parse('{"title":"Nextcloud","description":"","frontmatter":{"outline":"deep"},"headers":[],"relativePath":"docs/wi/nextcloud.md","filePath":"docs/wi/nextcloud.md","lastUpdated":1769674583000}'),l={name:"docs/wi/nextcloud.md"};function p(i,a,o,c,r,d){return n(),e("div",null,a[0]||(a[0]=[t(`<h1 id="nextcloud" tabindex="-1">Nextcloud <a class="header-anchor" href="#nextcloud" aria-label="Permalink to &quot;Nextcloud&quot;">​</a></h1><p>source: &quot;<a href="https://www.altlinux.org/Nextcloud" target="_blank" rel="noreferrer">https://www.altlinux.org/Nextcloud</a>)&quot;</p><p>Данная статья описывает частные случаи установки Nextcloud, официально рекомендованный способ его установки описан в документации дистрибутива ОС Альт, например в <a href="https://docs.altlinux.org/ru-RU/alt-server/10.1/html-single/alt-server/index.html#nextcloud" target="_blank" rel="noreferrer">Руководстве пользователя Альт Сервер 10.1</a>. Также стоит иметь в виду, что Nextcloud присутствует в репозитории p11, но по умолчанию не входит в состав продукта Альт Сервер 11.</p><p>В некоторых случаях описанные здесь (или в документации дистрибутива) способы установки (это не касается настройки самого Nextcloud) могут привести к трудно разрешимым проблемам при попытке апгрейда версии Nextcloud до актуальной. В этих условиях может иметь смысл использовать способ установки в виде &quot;All-in-one Docker image&quot; (рекомендованный) или &quot;All-in-one VM image&quot; (ограниченно рекомендованный) по ссылке <a href="https://nextcloud.com/install/" target="_blank" rel="noreferrer">https://nextcloud.com/install/</a>.</p><h2 id="что-такое-nextcloud" tabindex="-1">Что такое Nextcloud <a class="header-anchor" href="#что-такое-nextcloud" aria-label="Permalink to &quot;Что такое Nextcloud&quot;">​</a></h2><p>Nextcloud — веб-приложение для синхронизации данных, общего доступа к файлам и удалённого хранения документов в «облаке». Файлы Nextcloud хранятся в обычных структурах каталогов и могут быть доступны через WebDAV, если это необходимо. Основной сайт проекта: <a href="https://nextcloud.com/" target="_blank" rel="noreferrer">https://nextcloud.com/</a>. Nextcloud можно установить при установке ALT Linux Server 10.1, выбрав для установки пункт Сервер Nextcloud (подробнее описано в главе <a href="https://docs.altlinux.org/ru-RU/alt-server/10.1/html-single/alt-server/index.html#install-distro--install-system--chapter" target="_blank" rel="noreferrer">Установка системы</a>).</p><ul><li><a href="https://docs.altlinux.org/ru-RU/alt-server/10.1/html-single/alt-server/index.html#nextcloud" target="_blank" rel="noreferrer">Руководство пользователя Альт Сервер 10.1</a></li><li>Сайт: <a href="https://nextcloud.com/" target="_blank" rel="noreferrer">https://nextcloud.com</a> (<a href="http://docs.nextcloud.com/" target="_blank" rel="noreferrer">документация</a>)</li><li>Лицензия: AGPL-3.0</li></ul><h2 id="установка-nextcloud" tabindex="-1">Установка Nextcloud <a class="header-anchor" href="#установка-nextcloud" aria-label="Permalink to &quot;Установка Nextcloud&quot;">​</a></h2><p>Установить Nextcloud можно из репозитория или с официального сайта, если не устраивает версия из репозитория.</p><p><strong>Примечание:</strong> Начиная с версии php8.0, пакеты модулей именуются следующим образом:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>php&lt;мажорная&gt;.&lt;минорная версии&gt;-&lt;имя модуля&gt;</span></span></code></pre></div><p>Из репозитория можно установить и эксплуатировать в одной системе одновременно разные версии php.</p><h3 id="из-репозитория" tabindex="-1">Из репозитория <a class="header-anchor" href="#из-репозитория" aria-label="Permalink to &quot;Из репозитория&quot;">​</a></h3><h4 id="используя-deploy" tabindex="-1">Используя Deploy <a class="header-anchor" href="#используя-deploy" aria-label="Permalink to &quot;Используя Deploy&quot;">​</a></h4><p>Развернуть Nextcloud можно используя пакет deploy (см. <a href="https://www.altlinux.org/Deploy" title="Deploy" target="_blank" rel="noreferrer">Deploy</a>):</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># apt-get install deploy</span></span>
<span class="line"><span># deploy nextcloud</span></span></code></pre></div><p><strong>Примечание:</strong> Будет установлен веб-сервер Apache2 и PHP и развёрнута БД MariaDB. Устанавливаемая версия PHP зависит от используемого репозитория:</p><ul><li>в <a href="https://www.altlinux.org/P11" title="P11" target="_blank" rel="noreferrer">p11</a> — 8.3</li><li>в <a href="https://www.altlinux.org/P10" title="P10" target="_blank" rel="noreferrer">p10</a> — 8.2</li></ul><p>Nextcloud будет установлен в /var/www/webapps/nextcloud, веб-интерфейс будет доступен по ссылке:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>http://localhost/nextcloud</span></span></code></pre></div><p>Пользователь: ncadmin</p><h5 id="пароль-пользователя-ncadmin" tabindex="-1">Пароль пользователя ncadmin <a class="header-anchor" href="#пароль-пользователя-ncadmin" aria-label="Permalink to &quot;Пароль пользователя ncadmin&quot;">​</a></h5><p>При разворачивании nextcloud через deploy без параметров пароль пользователя ncadmin будет сгенерирован автоматически и будет совпадать с паролем пользователя базы данных. Поэтому его можно найти в файле /var/www/webapps/nextcloud/config/config.php в параметре dbpassword.</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># cd /var/www/webapps/nextcloud/config</span></span>
<span class="line"><span># cat config.php|grep &#39;dbpassword&#39;</span></span></code></pre></div><p>Также, чтобы узнать пароль пользователя ncadmin сразу после разворачивания, можно посмотреть значение параметра <em>admin-pass</em> в журнале:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># journalctl -b |grep admin-pass</span></span></code></pre></div><p><strong>Внимание!</strong> Рекомендуется сразу после разворачивания nextcloud изменить пароль пользователя ncadmin.</p><h6 id="смена-пароля" tabindex="-1">Смена пароля <a class="header-anchor" href="#смена-пароля" aria-label="Permalink to &quot;Смена пароля&quot;">​</a></h6><p>Установить пароль пользователю ncadmin можно, выполнив команду (пароль должен быть достаточно сложным и содержать не менее 10 символов):</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># deploy nextcloud password=5Z4SAq2U28rWyVz</span></span></code></pre></div><h4 id="по-шагам-веб-сервер-apache2" tabindex="-1">По шагам (веб-сервер Apache2) <a class="header-anchor" href="#по-шагам-веб-сервер-apache2" aria-label="Permalink to &quot;По шагам (веб-сервер Apache2)&quot;">​</a></h4><p>Установить Nextcloud и все необходимые для его работы модули можно, установив пакеты <a href="https://packages.altlinux.org/ru/sisyphus/nextcloud" target="_blank" rel="noreferrer">nextcloud</a> и <a href="https://packages.altlinux.org/ru/sisyphus/nextcloud-apache2" target="_blank" rel="noreferrer">nextcloud-apache2</a>:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># apt-get install nextcloud nextcloud-apache2</span></span></code></pre></div><p><strong>Примечание:</strong> Устанавливаемая версия PHP зависит от используемого репозитория:</p><ul><li>в <a href="https://www.altlinux.org/P11" title="P11" target="_blank" rel="noreferrer">p11</a> — 8.3</li><li>в <a href="https://www.altlinux.org/P10" title="P10" target="_blank" rel="noreferrer">p10</a> — 8.2</li></ul><p>Nextcloud будет установлен в /var/www/webapps/nextcloud, файл конфигурации — /var/www/webapps/nextcloud/config/config.php.</p><p>В пакет nextcloud-apache2 входит файл настроек виртуального хоста nextcloud: /etc/httpd2/conf/sites-available/nextcloud.conf. Также при установке этого пакета автоматически этот хост включается в разрешенные и включаются все необходимые для оптимальной работы сервиса модули apache2.</p><p>Запустить веб-сервер Apache2 и добавить его в автозагрузку:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># systemctl enable --now httpd2</span></span></code></pre></div><p>Веб-интерфейс будет доступен по ссылке <a href="http://your_web_server_adress/nextcloud" target="_blank" rel="noreferrer">http://your_web_server_adress/nextcloud</a></p><p>Далее необходимо зайти на веб-интерфейс Nextcloud и <a href="https://www.altlinux.org/#%D0%97%D0%B0%D0%B2%D0%B5%D1%80%D1%88%D0%B5%D0%BD%D0%B8%D0%B5_%D1%83%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B8" target="_blank" rel="noreferrer">завершить установку</a>.</p><h4 id="по-шагам-веб-сервер-nginx" tabindex="-1">По шагам (веб-сервер nginx) <a class="header-anchor" href="#по-шагам-веб-сервер-nginx" aria-label="Permalink to &quot;По шагам (веб-сервер nginx)&quot;">​</a></h4><p>Для установки Nextcloud с веб-сервером nginx необходимо установить пакеты (с зависимостями):</p><ul><li><p>в <a href="https://www.altlinux.org/P11" title="P11" target="_blank" rel="noreferrer">p11</a>:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># apt-get install nextcloud nextcloud-nginx php8.3-{fpm-fcgi,opcache}</span></span>
<span class="line"><span># systemctl enable --now php8.3-fpm</span></span></code></pre></div></li><li><p>Не забудьте установить СУБД (<a href="https://www.altlinux.org/EnterpriseApps/MariaDB" title="EnterpriseApps/MariaDB" target="_blank" rel="noreferrer">MariaDB</a>, SQLite или PostreSQL) и php-pdo для выбранной СУБД (по зависимостям устанавливаются <a href="https://packages.altlinux.org/ru/sisyphus/php8.3-pdo_sqlite" target="_blank" rel="noreferrer">php8.3-pdo_sqlite</a> и <a href="https://packages.altlinux.org/ru/sisyphus/libsqlite3" target="_blank" rel="noreferrer">libsqlite3</a>, но разработчики nextcloud его не рекомендуют): см. <a href="https://www.altlinux.org/Nextcloud#%D0%92%D1%8B%D0%B1%D0%BE%D1%80_%D0%91%D0%94" target="_blank" rel="noreferrer">https://www.altlinux.org/Nextcloud#Выбор_БД</a></p></li><li><p>Для нагруженного сервера имеет смысл установить пакет для кэширования (<a href="https://packages.altlinux.org/ru/sisyphus/php8.3-apcu" target="_blank" rel="noreferrer">php8.3-apcu</a>, <a href="https://packages.altlinux.org/ru/sisyphus/php8.3-memcached" target="_blank" rel="noreferrer">php8.3-memcached</a>,<a href="https://packages.altlinux.org/ru/sisyphus/php8.3-redis" target="_blank" rel="noreferrer">php8.3-redis</a>, понадобится дополнительная настройка):</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># apt-get install php8.3-apcu</span></span></code></pre></div></li><li><p>в <a href="https://www.altlinux.org/P10" title="P10" target="_blank" rel="noreferrer">p10</a>:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># apt-get install nextcloud nextcloud-nginx php8.2-{fpm-fcgi,apcu,opcache}</span></span>
<span class="line"><span># systemctl enable --now php8.2-fpm</span></span></code></pre></div></li></ul><p>Пакет <a href="https://packages.altlinux.org/ru/sisyphus/nextcloud-nginx" target="_blank" rel="noreferrer">nextcloud-nginx</a> включает файл настроек виртуального хоста nextcloud: /etc/nginx/sites-available.d/nextcloud.conf.</p><p>В файле /etc/nginx/sites-available.d/nextcloud.conf проверьте версию php и, если она отличается от установленной, измените её:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>server unix:/var/run/php8.3-fpm/php8.3-fpm.sock;</span></span></code></pre></div><p>и имя сервера в поле <em>server_name</em>.</p><p>Включить виртуальный хост и запустить веб-сервер:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># ln -s /etc/nginx/sites-available.d/nextcloud.conf /etc/nginx/sites-enabled.d/</span></span>
<span class="line"><span># systemctl enable --now nginx</span></span></code></pre></div><p>Веб-интерфейс будет доступен по ссылке <a href="http://your_web_server_adress/nextcloud" target="_blank" rel="noreferrer">http://your_web_server_adress/nextcloud</a></p><p>Далее необходимо зайти на веб-интерфейс Nextcloud и <a href="https://www.altlinux.org/#%D0%97%D0%B0%D0%B2%D0%B5%D1%80%D1%88%D0%B5%D0%BD%D0%B8%D0%B5_%D1%83%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B8" target="_blank" rel="noreferrer">завершить установку</a>.</p><p>Также можно настроить получение сертификатов от Let&#39;s Encrypt, например, с помощью пакета <a href="https://packages.altlinux.org/ru/sisyphus/dehydrated" target="_blank" rel="noreferrer">dehydrated</a>.</p><h3 id="с-официального-саита-nextcloud-с-сервером-apache2-с-помощью-веб-установщика" tabindex="-1">С официального сайта Nextcloud с сервером Apache2 (с помощью веб-установщика) <a class="header-anchor" href="#с-официального-саита-nextcloud-с-сервером-apache2-с-помощью-веб-установщика" aria-label="Permalink to &quot;С официального сайта Nextcloud с сервером Apache2 (с помощью веб-установщика)&quot;">​</a></h3><h4 id="подготовка-окружения" tabindex="-1">Подготовка окружения <a class="header-anchor" href="#подготовка-окружения" aria-label="Permalink to &quot;Подготовка окружения&quot;">​</a></h4><p>Для работы Nextcloud нужен настроенный веб-сервер. Потребуется установить следующие пакеты [^1] [^2]:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># apt-get install apache2 apache2-mod_ssl apache2-mod_php8.3 tzdata php8.3</span></span>
<span class="line"><span># apt-get install php8.3-{curl,dom,exif,fileinfo,gd2,gmp,imagick,intl,libs,mbstring,memcached,opcache,openssl,pcntl,pdo,xmlreader,zip}</span></span></code></pre></div><p><strong>Примечание:</strong> Список устанавливаемых пакетов можно уточнить, ориентируясь на зависимости пакетов из репозитория:[^3]</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ apt-cache depends nextcloud nextcloud-apache2</span></span></code></pre></div><p>Разрешим нужные модули Apache2:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># for mod in dir env headers mime rewrite ssl; do a2enmod $mod; done</span></span></code></pre></div><p>Запустим веб-сервер Apache2 и добавим его в автозагрузку:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># systemctl enable --now httpd2</span></span></code></pre></div><h4 id="установка" tabindex="-1">Установка <a class="header-anchor" href="#установка" aria-label="Permalink to &quot;Установка&quot;">​</a></h4><p>С сайта <a href="https://nextcloud.com/install/" target="_blank" rel="noreferrer">https://nextcloud.com/install/</a> (раздел «Download» -&gt; «Web-installer») необходимо скачать в корень веб-сервера /var/www/html файл setup-nextcloud.php, например:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># cd /var/www/html/</span></span>
<span class="line"><span># wget https://download.nextcloud.com/server/installer/setup-nextcloud.php</span></span></code></pre></div><p>У веб-сервера должны быть права на запись в каталог с файлом setup-nextcloud.php. Права можно назначить, временно, добавив пользователя apache2 в группу webmaster:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># gpasswd -a apache2 webmaster</span></span>
<span class="line"><span># systemctl restart httpd2</span></span></code></pre></div><p>Далее переходим по ссылке <a href="http://your_web_server_adress/setup-nextcloud.php" target="_blank" rel="noreferrer">http://your_web_server_adress/setup-nextcloud.php</a> и следуем инструкциям установщика.</p><p><a href="https://www.altlinux.org/%D0%A4%D0%B0%D0%B9%D0%BB:NextcloudInstallFolder.png" target="_blank" rel="noreferrer"><img src="https://www.altlinux.org/Images.www.altlinux.org/5/5f/NextcloudInstallFolder.png" alt=""></a></p><p>Установка Nextcloud. Проверка зависимостей и выбор каталога</p><p>По умолчанию Nextcloud устанавливается в подкаталог nextcloud (например, /var/www/html/nextcloud).</p><p>После установки удалим пользователя apache2 из группы webmaster:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># gpasswd -d apache2 webmaster</span></span></code></pre></div><p>Для <a href="https://www.altlinux.org/Nextcloud#%D0%97%D0%B0%D0%B2%D0%B5%D1%80%D1%88%D0%B5%D0%BD%D0%B8%D0%B5_%D1%83%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B8" title="Nextcloud" target="_blank" rel="noreferrer">завершения установки</a> необходимо создать учетную запись администратора Nextcloud и выбрать тип используемой БД.</p><p><strong>Примечание:</strong> Если при установке системы был установлен пакет installer-feature-apache2-indexhtml-stage3, который в файлах /etc/httpd2/conf/sites-available/default.conf и /etc/httpd2/conf/sites-available/default_https.conf меняет строку <strong>/var/www/html</strong> на <strong>/usr/share/doc/indexhtml/</strong>, то исправить это можно, выполнив команду:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># sed -i &quot;s|/usr/share/doc/indexhtml|/var/www/html|&quot; /etc/httpd2/conf/sites-available/{default,default_https}.conf</span></span></code></pre></div><p>И затем перезагрузить веб-сервер:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># systemctl restart httpd2</span></span></code></pre></div><h4 id="рекомендации-по-безопасности" tabindex="-1">Рекомендации по безопасности <a class="header-anchor" href="#рекомендации-по-безопасности" aria-label="Permalink to &quot;Рекомендации по безопасности&quot;">​</a></h4><p>Рекомендуется сменить владельца файлов nextcloud на root, оставив Apache2 доступ на запись к каталогам data, config, apps:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># chown -R root /var/www/html/nextcloud/</span></span>
<span class="line"><span># chown -R apache2 /var/www/html/nextcloud/{apps,config,data}/</span></span></code></pre></div><h2 id="завершение-установки" tabindex="-1">Завершение установки <a class="header-anchor" href="#завершение-установки" aria-label="Permalink to &quot;Завершение установки&quot;">​</a></h2><p><a href="https://www.altlinux.org/%D0%A4%D0%B0%D0%B9%D0%BB:NextcloudInstallSQLite.png" target="_blank" rel="noreferrer"><img src="https://www.altlinux.org/Images.www.altlinux.org/2/26/NextcloudInstallSQLite.png" alt=""></a></p><p>Установка Nextcloud с базой данных SQLite</p><p>Для завершения установки необходимо создать учетную запись администратора Nextcloud и выбрать тип используемой БД.</p><p>По умолчанию используется SQLite, но для крупных проектов рекомендуется выбрать другой тип базы данных.</p><h3 id="выбор-бд" tabindex="-1">Выбор БД <a class="header-anchor" href="#выбор-бд" aria-label="Permalink to &quot;Выбор БД&quot;">​</a></h3><p><strong>Примечание:</strong> Если вы выполняли установку с помощью deploy, то была автоматически создана база данных MySQL и этот шаг можно пропустить</p><h4 id="sqlite" tabindex="-1">SQLite <a class="header-anchor" href="#sqlite" aria-label="Permalink to &quot;SQLite&quot;">​</a></h4><p>Если будет использоваться база данных SQLite, для создания учётной записи администратора Nextcloud достаточно заполнить поля «Имя пользователя» и «Пароль», и нажать кнопку «Завершить установку».</p><h4 id="mysql-mariadb-для-nextcloud" tabindex="-1">MySQL/MariaDB для Nextcloud <a class="header-anchor" href="#mysql-mariadb-для-nextcloud" aria-label="Permalink to &quot;MySQL/MariaDB для Nextcloud&quot;">​</a></h4><p><a href="https://www.altlinux.org/%D0%A4%D0%B0%D0%B9%D0%BB:NextcloudInstallMySQL.png" target="_blank" rel="noreferrer"><img src="https://www.altlinux.org/Images.www.altlinux.org/6/6d/NextcloudInstallMySQL.png" alt=""></a></p><p>Установка Nextcloud с базой данных MySQL</p><p>Если будет использоваться база данных MySQL/MariaDB:</p><ol><li>Установить необходимые пакеты для MySQL или для MariDB (php8.2-pdo_mysql — в <a href="https://www.altlinux.org/P10" title="P10" target="_blank" rel="noreferrer">p10</a>:<div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># apt-get install MySQL[mariadb]-server php8.3-pdo_mysql php8.3-mysqlnd</span></span></code></pre></div>Версия php должна быть указана та, которая использовалась при установке Nextcloud.</li><li>Запустить сервер mysqld и добавить его в автозагрузку:<div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># systemctl enable --now mysqld (mariadb.service)</span></span></code></pre></div></li><li>Создать базу данных для Nextcloud: <ul><li>авторизоваться на сервере базы данных:<div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ mysql -u root</span></span></code></pre></div></li><li>или, если пароль пользователя root@localhost в MySQL установлен:<div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ mysql -u root -p</span></span>
<span class="line"><span>Enter password:</span></span></code></pre></div></li><li>Выполнить команды для создания базы данных nextcloud и пользователя базы данных nextcloud с паролем nextpass:<div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>MariaDB [(none)]&gt; create user &#39;nextcloud&#39;@&#39;localhost&#39; identified by &#39;nextpass&#39;;</span></span>
<span class="line"><span>MariaDB [(none)]&gt; create database nextcloud default character set utf8 collate utf8_unicode_ci;</span></span>
<span class="line"><span>MariaDB [(none)]&gt; grant all privileges on nextcloud.* to nextcloud@localhost;</span></span>
<span class="line"><span>MariaDB [(none)]&gt; exit;</span></span></code></pre></div></li></ul></li><li>В веб-интерфейсе Nextcloud заполнить поля «Имя пользователя» и «Пароль», раскрыть список «Хранилище и база данных», выбрать «MySQL/MariaDB», и заполнить поля подключения к базе данных, данными, которые использовались на этапе настройки базы данных. Для завершения установки необходимо нажать кнопку «Завершить установку».</li></ol><h4 id="postgresql" tabindex="-1">PostgreSQL <a class="header-anchor" href="#postgresql" aria-label="Permalink to &quot;PostgreSQL&quot;">​</a></h4><p><strong>Примечание:</strong> В <a href="https://www.altlinux.org/P11" title="P11" target="_blank" rel="noreferrer">p11</a> поддерживается несколько версий PostgreSQL, в данной статье речь о 17 версии.</p><p>Для <a href="https://www.altlinux.org/P10" title="P10" target="_blank" rel="noreferrer">p10</a> следует установить следующие пакеты (версия postgresql 14):</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># apt-get install postgresql14-server php8.2-{pgsql,pdo_pgsql}</span></span></code></pre></div><p><a href="https://www.altlinux.org/%D0%A4%D0%B0%D0%B9%D0%BB:NextcloudInstallPostgreSQL.png" target="_blank" rel="noreferrer"><img src="https://www.altlinux.org/Images.www.altlinux.org/7/7a/NextcloudInstallPostgreSQL.png" alt=""></a></p><p>Установка Nextcloud с базой данных PostgreSQL</p><p>Если будет использоваться СУБД PostgreSQL:</p><ol><li>Установить необходимые пакеты:<div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># apt-get install postgresql17-server php8.3-pgsql php8.3-pdo_pgsql</span></span></code></pre></div>Версия php должна быть указана та, которая использовалась при установке Nextcloud.</li><li>Подготовить к запуску и настроить службу postgresql: <ul><li>создать системные базы данных:<div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># /etc/init.d/postgresql initdb</span></span></code></pre></div></li><li>включить по умолчанию и запустить службу postgresql:<div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># systemctl enable --now postgresql</span></span></code></pre></div></li></ul></li><li>Создать базу данных Nextcloud: <ul><li>создать пользователя nextcloud (пароль необходимо запомнить) и базу данных nextcloud:<div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># su - postgres -s /bin/bash -c &#39;createuser --no-superuser --no-createdb --no-createrole --encrypted --pwprompt nextcloud&#39;</span></span>
<span class="line"><span>Введите пароль для новой роли: </span></span>
<span class="line"><span>Повторите его:</span></span>
<span class="line"><span># su - postgres -s /bin/bash -c &#39;createdb -O nextcloud nextcloud&#39;</span></span></code></pre></div></li></ul></li><li>В веб-интерфейсе Nextcloud заполнить поля «Имя пользователя» и «Пароль», раскрыть список «Хранилище и база данных», выбрать PostgreSQL, и заполнить поля подключения к базе данных, данными, которые использовались на этапе создания базы данных. Для завершения установки необходимо нажать кнопку «Завершить установку».</li></ol><h3 id="настроика-кэширования" tabindex="-1">Настройка кэширования <a class="header-anchor" href="#настроика-кэширования" aria-label="Permalink to &quot;Настройка кэширования&quot;">​</a></h3><p>Можно значительно повысить производительность сервера Nextcloud с помощью кэширования, при котором часто запрашиваемые объекты сохраняются в памяти для более быстрого извлечения.</p><p>Установить следующие пакеты:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># apt-get install php8.3-{apcu,memcached} memcached</span></span></code></pre></div><p>Версия PHP должна быть указана та, которая использовалась при установке Nextcloud.</p><p>Добавить службу memcached в автозагрузку и запустить её:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># systemctl enable --now memcached</span></span></code></pre></div><p>Добавить в config.php (находится в каталоге /var/www/html/nextcloud/config/ или /var/www/webapps/nextcloud/config/  — при установке из репозитория) следующие строки:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>&#39;memcache.local&#39; =&gt; &#39;\\OC\\Memcache\\APCu&#39;,</span></span>
<span class="line"><span>&#39;memcache.distributed&#39; =&gt; &#39;\\OC\\Memcache\\Memcached&#39;,</span></span>
<span class="line"><span>&#39;memcache.locking&#39; =&gt; &#39;\\OC\\Memcache\\Memcached&#39;,</span></span>
<span class="line"><span>&#39;memcached_servers&#39; =&gt; array(</span></span>
<span class="line"><span>   array(&#39;localhost&#39;, 11211),</span></span>
<span class="line"><span>),</span></span></code></pre></div><h3 id="доверенные-домены" tabindex="-1">Доверенные домены <a class="header-anchor" href="#доверенные-домены" aria-label="Permalink to &quot;Доверенные домены&quot;">​</a></h3><p>Все URL-адреса, используемые для доступа к серверу Nextcloud, должны быть внесены в белый список в файле config.php в настройках <em>trusted_domains</em>. Пользователям разрешено входить в Nextcloud только в том случае, если они указывают в своих браузерах URL-адрес, указанный в настройке доверенных_доменов.</p><p>Пример настройки <em>trusted_domains</em> в файле конфигурации:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>&#39;trusted_domains&#39; =&gt;</span></span>
<span class="line"><span>array (</span></span>
<span class="line"><span>0 =&gt; &#39;localhost&#39;,</span></span>
<span class="line"><span>1 =&gt; &#39;nextcloud.test.alt&#39;,</span></span>
<span class="line"><span>2 =&gt; &#39;192.168.0.123&#39;,</span></span>
<span class="line"><span>),</span></span></code></pre></div><h3 id="настроика-ssl" tabindex="-1">Настройка SSL <a class="header-anchor" href="#настроика-ssl" aria-label="Permalink to &quot;Настройка SSL&quot;">​</a></h3><p>Для правильной работы nextcloud запросы должны идти по https. Для работы SSL необходимы SSL-сертификаты. Их можно купить или сгенерировать.</p><h4 id="создание-самоподписных-ssl-сертификатов" tabindex="-1">Создание самоподписных SSL-сертификатов <a class="header-anchor" href="#создание-самоподписных-ssl-сертификатов" aria-label="Permalink to &quot;Создание самоподписных SSL-сертификатов&quot;">​</a></h4><ol><li>Создать и перейти в каталог ~/ssl:<div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ mkdir ~/ssl &amp;&amp; cd ~/ssl</span></span></code></pre></div></li><li>Создать закрытый ключ корневого хранилища:<div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ openssl genrsa -des3 -out nextcloud-domain-ca.key 2048</span></span></code></pre></div></li><li>Создать и подписать ключом корневого хранилища корневой сертификат, сертификат издателя сертификатов (при запросе «Common Name» необходимо указать IP-адрес или FQDN вашего сервера):<div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ openssl req -new -x509 -days 3650 -key nextcloud-domain-ca.key -out nextcloud-domain-ca.crt</span></span></code></pre></div></li><li>Создать закрытый ключ веб-сервера, который вы намерены защитить сертификатом:<div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ openssl genrsa -des3 -out nextcloud.key 1024</span></span></code></pre></div></li><li>Создать запрос на подпись сертификата веб-сервера (при запросе «Common Name» необходимо указать IP-адрес или FQDN вашего сервера):<div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ openssl req -new -key nextcloud.key -out nextcloud.csr</span></span></code></pre></div></li><li>Создать и подписать сертификат веб-сервера, используя запрос на подпись сертификата, корневой ключ и корневой сертификат:<div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ openssl x509 -req -in nextcloud.csr -out nextcloud.crt -sha1 -CA nextcloud-domain-ca.crt -CAkey nextcloud-domain-ca.key -CAcreateserial -days 3650</span></span></code></pre></div></li><li>Apache2 будет требовать при запуске пароль к ключу веб-сервера. Если этого не требуется, можно сделать резервную копию ключа веб-сервера:<div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ cp nextcloud.key nextcloud.key.dist</span></span></code></pre></div>и очистить пароль ключа веб-сервера:<div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ openssl rsa -in nextcloud.key.dist -out nextcloud.key</span></span></code></pre></div></li><li>Создать цепочку сертификатов CA-bundle:<div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ cat nextcloud.crt nextcloud-domain-ca.crt &gt; nextcloud.ca-bundle</span></span></code></pre></div></li><li>В итоге должны получиться следующие файлы:<div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>nextcloud.crt — сертификат сервера</span></span>
<span class="line"><span>nextcloud.csr — запрос на сертификат</span></span>
<span class="line"><span>nextcloud.key — ключ сертификата сервера</span></span>
<span class="line"><span>nextcloud.ca-bundle — ca-bundle файл сайта</span></span>
<span class="line"><span>nextcloud-domain-ca.crt — корневой сертификат</span></span>
<span class="line"><span>nextcloud-domain-ca.key — ключ корневого сертификата</span></span></code></pre></div></li><li>Скопировать корневой сертификат, сертификат сервера и ca-bundle файл сайта в /var/lib/ssl/certs/, а ключ сертификата сервера в /var/lib/ssl/private/:<div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># cp /home/user/ssl/nextcloud.key /var/lib/ssl/private/</span></span>
<span class="line"><span># cp /home/user/ssl/{nextcloud-domain-ca.crt,nextcloud.crt,nextcloud.ca-bundle} /var/lib/ssl/certs/</span></span></code></pre></div></li></ol><h4 id="конфигурационныи-фаил-apache2" tabindex="-1">Конфигурационный файл Apache2 <a class="header-anchor" href="#конфигурационныи-фаил-apache2" aria-label="Permalink to &quot;Конфигурационный файл Apache2&quot;">​</a></h4><p>Теперь создадим конфигурационный файл нашего сайта и настроим SSL-доступ.</p><p>Включить 443 порт:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># a2enport https</span></span></code></pre></div><p>Скопировать стандартный конфигурационный файл и назовём его nextcloud.conf:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># cd /etc/httpd2/conf/sites-available/</span></span>
<span class="line"><span># cp default_https.conf nextcloud.conf</span></span></code></pre></div><p>Пример конфигурационного файла /etc/httpd2/conf/sites-available/nextcloud.conf (вместо DNS-имени можно указать IP-адрес):</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>&lt;IfModule ssl_module&gt;</span></span>
<span class="line"><span>   &lt;VirtualHost *:443&gt;</span></span>
<span class="line"><span>      DocumentRoot &quot;/var/www/html/nextcloud&quot; (завелось после правки в вид &quot;/var/www/html&quot;)</span></span>
<span class="line"><span>      ServerName nextcloud.test.alt:443</span></span>
<span class="line"><span>      ServerAdmin webmaster@example.com</span></span>
<span class="line"><span>      ErrorLog &quot;/var/log/httpd2/error_log&quot;</span></span>
<span class="line"><span>      TransferLog &quot;/var/log/httpd2/access_log&quot;</span></span>
<span class="line"><span>      SSLEngine on</span></span>
<span class="line"><span>      SSLProtocol all -SSLv2</span></span>
<span class="line"><span>      SSLCipherSuite HIGH:MEDIUM:!aNULL:!MD5</span></span>
<span class="line"><span>      SSLCertificateFile &quot;/var/lib/ssl/certs/nextcloud.crt&quot;</span></span>
<span class="line"><span>      SSLCertificateKeyFile &quot;/var/lib/ssl/private/nextcloud.key&quot;</span></span>
<span class="line"><span>      SSLCertificateChainFile &quot;/var/lib/ssl/certs/nextcloud.ca-bundle&quot;</span></span>
<span class="line"><span>      SSLCACertificateFile &quot;/var/lib/ssl/certs/nextcloud-domain-ca.crt&quot;</span></span>
<span class="line"><span>      &lt;IfModule mod_headers.c&gt;</span></span>
<span class="line"><span>            Header always set Strict-Transport-Security &quot;max-age=15552000; includeSubDomains; preload&quot;</span></span>
<span class="line"><span>      &lt;/IfModule&gt;</span></span>
<span class="line"><span>      &lt;Directory /var/www/html/nextcloud&gt;</span></span>
<span class="line"><span>            AllowOverride All</span></span>
<span class="line"><span>      &lt;/Directory&gt;</span></span>
<span class="line"><span>   &lt;/VirtualHost&gt;</span></span>
<span class="line"><span>&lt;/IfModule&gt;</span></span></code></pre></div><p>Так же можно настроить редирект с http на https добавив в файл конфигурации раздел:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>&lt;VirtualHost *:80&gt;</span></span>
<span class="line"><span>   ServerName nextcloud.test.alt</span></span>
<span class="line"><span>   Redirect permanent / https://nextcloud.test.alt/</span></span>
<span class="line"><span>&lt;/VirtualHost&gt;</span></span></code></pre></div><p><strong>Примечание:</strong> Если nextcloud устанавливался из репозитория, /var/www/html/nextcloud в директиве <strong>DocumentRoot</strong> и <strong>Directory</strong> необходимо заменить на /var/www/webapps/nextcloud.</p><p>Добавить сайт nextcloud в разрешенные и перезапустить веб-сервер:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># a2ensite nextcloud</span></span>
<span class="line"><span># systemctl restart httpd2</span></span></code></pre></div><p>Теперь Nextcloud доступен по адресу <a href="https://nextcloud.test.alt/" target="_blank" rel="noreferrer">https://nextcloud.test.alt/</a> При первом заходе по https браузер будет ругаться на самоподписанный сертификат (ошибка SEC_ERROR_UNKNOWN_ISSUER) необходимо добавить его в исключения.</p><h4 id="конфигурационныи-фаил-nginx" tabindex="-1">Конфигурационный файл nginx <a class="header-anchor" href="#конфигурационныи-фаил-nginx" aria-label="Permalink to &quot;Конфигурационный файл nginx&quot;">​</a></h4><p>развернуть Пример конфигурационного файла /etc/nginx/sites-available.d/nextcloud.conf:</p><h2 id="обновление-мажорных-версии" tabindex="-1">Обновление мажорных версий <a class="header-anchor" href="#обновление-мажорных-версии" aria-label="Permalink to &quot;Обновление мажорных версий&quot;">​</a></h2><p>По умолчанию непоследовательное обновление мажорных версий запрещено (например, с версии 20 сразу до 22), и при попытке доступа к веб-интерфейсу после обновления пакета будет возникать ошибка &quot;Exception: Updates between multiple major versions and downgrades are unsupported&quot;. Для того, чтобы обойти эту ошибку, продолжить обновление и получить доступ к веб-интерфейсу, можно сделать следующее. В файле /var/www/webapps/nextcloud/config/config.php в параметре &#39;version&#39; изменить старую версию на новую. Затем снова перейти в веб-интерфейс, обновить страницу и обновление должно продолжиться.</p><h2 id="collabora-online-в-nextcloud" tabindex="-1">Collabora Online в Nextcloud <a class="header-anchor" href="#collabora-online-в-nextcloud" aria-label="Permalink to &quot;Collabora Online в Nextcloud&quot;">​</a></h2><h3 id="описание" tabindex="-1">Описание <a class="header-anchor" href="#описание" aria-label="Permalink to &quot;Описание&quot;">​</a></h3><p>Collabora Online это мощный онлайн офисный пакет, основанный на LibreOffice, который позволяет работать со всеми основными офисными форматами (документы/таблицы/презентации) прямо в браузере.</p><p>Особенности:</p><ul><li>Базовое редактирование</li><li>Поддержка документов: <ul><li>DOC, DOCX, PPT, PPTX, XLS, XLSX + ODF</li><li>Импорт/Просмотр Visio, Publisher, + более 100</li></ul></li><li>WYSIWYG редактор</li><li>Анонимное редактирование файлов доступных для общего пользования</li></ul><h3 id="встраиваемыи-сервер-code-collabora-online-development-edition" tabindex="-1">Встраиваемый сервер CODE (Collabora Online Development Edition) <a class="header-anchor" href="#встраиваемыи-сервер-code-collabora-online-development-edition" aria-label="Permalink to &quot;Встраиваемый сервер CODE (Collabora Online Development Edition)&quot;">​</a></h3><p>Простой в установке вариант, предназначенный для использования дома или в небольших группах. Производительность несколько ниже, чем в варианте использования отдельного сервера, а также отсутствуют возможности для масштабирования.</p><p>Установка:</p><ol><li>Установить приложение «Collabora Online - Built-in CODE Server» («Значок пользователя» → «Приложения» → «Офис и текст» → «Collabora Online - Built-in CODE Server» -&gt; «Скачать и включить»).</li><li>Установить приложение «Nextcloud Office» («Значок пользователя» → «Приложения» → «Офис и текст» → «Nextcloud Office» -&gt; «Скачать и включить»). <a href="https://www.altlinux.org/%D0%A4%D0%B0%D0%B9%D0%BB:Nextcloud_collabora02.png" title="Установленные приложения в Nextcloud" target="_blank" rel="noreferrer"><img src="https://www.altlinux.org/Images.www.altlinux.org/thumb/f/f3/Nextcloud_collabora02.png/800px-Nextcloud_collabora02.png" alt="Установленные приложения в Nextcloud"></a></li><li>Перейти в «Значок пользователя» → «Параметры сервера» → «Офис» и выбрать пункт «Использовать встраиваемый сервер CODE (Collabora Online Development Edition)»: <a href="https://www.altlinux.org/%D0%A4%D0%B0%D0%B9%D0%BB:Nextcloud_collabora01.png" title="Настройка встроенного сервера Collabora в Nextcloud" target="_blank" rel="noreferrer"><img src="https://www.altlinux.org/Images.www.altlinux.org/thumb/1/17/Nextcloud_collabora01.png/800px-Nextcloud_collabora01.png" alt="Настройка встроенного сервера Collabora в Nextcloud"></a></li></ol><p><strong>Примечание:</strong> Если используется веб-сервер Nginx, то необходимо внести небольшие изменения в существующую конфигурацию. Чтобы приложение Collabora Online работало, необходимо добавить точку входа richdocumentscode/proxy в качестве разрешенного местоположения в конфигурацию nginx. Т.е. в файле /etc/nginx/sites-available.d/nextcloud.conf заменить строку:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>location ~ ^/(?:index|remote|public|cron|core/ajax/update|status|ocs/v[12]|updater/.+|oc[ms]-provider/.+)\\.php(?:$|/) {</span></span></code></pre></div><p>на:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>location ~ ^/(?:index|remote|public|cron|core/ajax/update|status|ocs/v[12]|updater/.+|oc[ms]-provider/.+|.+\\/richdocumentscode\\/proxy)\\.php(?:$|/) {</span></span></code></pre></div><p>И перезапустить nginx:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># systemctl restart nginx</span></span></code></pre></div><p>Перейти к папкам и файлам на облачном сервисе. Попробовать открыть любой документ или создать новый — он должен открыться в Collabora:</p><p><a href="https://www.altlinux.org/%D0%A4%D0%B0%D0%B9%D0%BB:Nextcloud_collabora03.png" title="Редактирование документа в браузере" target="_blank" rel="noreferrer"><img src="https://www.altlinux.org/Images.www.altlinux.org/thumb/d/de/Nextcloud_collabora03.png/800px-Nextcloud_collabora03.png" alt="Редактирование документа в браузере"></a></p><h3 id="собственныи-сервер-collabora-online" tabindex="-1">Собственный сервер Collabora Online <a class="header-anchor" href="#собственныи-сервер-collabora-online" aria-label="Permalink to &quot;Собственный сервер Collabora Online&quot;">​</a></h3><p>В данном разделе приведён пример запуска собственного сервера «Nextcloud Office» на одном сервере с Nextcloud.</p><h4 id="установка-и-запуск-сервера-collabora" tabindex="-1">Установка и запуск сервера Collabora <a class="header-anchor" href="#установка-и-запуск-сервера-collabora" aria-label="Permalink to &quot;Установка и запуск сервера Collabora&quot;">​</a></h4><p>Для работы собственного сервера Collabora Online необходимо установить и настроить <a href="https://www.altlinux.org/Podman" title="Podman" target="_blank" rel="noreferrer">Podman</a>.</p><p><strong>Примечание:</strong> Должен быть установлен пакет fuse и fuse-overlayfs. Кроме того, необходимо предоставить права доступа для монтирования файловой системы FUSE для всех пользователей:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># control fusermount public</span></span></code></pre></div><p>Далее необходимо скачать образ Collabora Online:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ podman pull collabora/code</span></span></code></pre></div><p>Запустить образ:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ podman run -t -d -p 127.0.0.1:9980:9980 -e &#39;aliasgroup=https://nextcloud.test.alt:443&#39; --restart always --cap-add MKNOD --privileged collabora/code</span></span></code></pre></div><p>где:</p><ul><li>контейнер будет слушать сетевые запросы на порту 9980 (параметр -p);</li><li>в параметре aliasgroup должен быть указан хост, на котором работает Nextcloud.</li></ul><h4 id="настроика-reverse-proxy" tabindex="-1">Настройка reverse proxy <a class="header-anchor" href="#настроика-reverse-proxy" aria-label="Permalink to &quot;Настройка reverse proxy&quot;">​</a></h4><p>Далее надо настроить reverse proxy.</p><p>Для пересылки запросов демону Coolwsd на порт 9980 должны быть установлены следующие правила:</p><ul><li>/browser</li><li>/hosting/discovery</li><li>/hosting/capabilities</li><li>/cool/adminws</li><li>/cool</li><li>Подключение к веб-сокету через /cool/(.*)/ws</li></ul><h5 id="веб-сервер-apache2" tabindex="-1">Веб-сервер Apache2 <a class="header-anchor" href="#веб-сервер-apache2" aria-label="Permalink to &quot;Веб-сервер Apache2&quot;">​</a></h5><p>Загрузить необходимые модули:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># for mod in proxy proxy_wstunnel proxy_http proxy_connect; do a2enmod $mod; done</span></span></code></pre></div><p>После этого необходимо правильно сконфигурировать Apache2, в данном примере мы запустим обратный прокси на порту 4443. Его можно также запустить на поддомене (например, office.test.alt).</p><p>Создадим в каталоге /etc/httpd2/conf/sites-available/ файл officenextcloud.conf следующего содержания:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>&lt;VirtualHost *:4443&gt;</span></span>
<span class="line"><span>  ServerName nextcloud.test.alt:4443</span></span>
<span class="line"><span>SSLEngine on</span></span>
<span class="line"><span>  SSLCertificateFile &quot;/var/lib/ssl/certs/nextcloud.crt&quot;</span></span>
<span class="line"><span>  SSLCertificateKeyFile &quot;/var/lib/ssl/private/nextcloud.key&quot;</span></span>
<span class="line"><span>  SSLCertificateChainFile &quot;/var/lib/ssl/certs/nextcloud.ca-bundle&quot;</span></span>
<span class="line"><span>  SSLCACertificateFile &quot;/var/lib/ssl/certs/nextcloud-domain-ca.crt&quot;</span></span>
<span class="line"><span>  SSLProtocol             all -SSLv2 -SSLv3</span></span>
<span class="line"><span>  SSLCipherSuite HIGH:MEDIUM:!aNULL:!MD5</span></span>
<span class="line"><span>  SSLHonorCipherOrder     on</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  ErrorLog &quot;/var/log/httpd2/office_error_log&quot;</span></span>
<span class="line"><span>  TransferLog &quot;/var/log/httpd2/office_access_log&quot;</span></span>
<span class="line"><span>  # Encoded slashes need to be allowed</span></span>
<span class="line"><span>  AllowEncodedSlashes NoDecode</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  # Container uses a unique non-signed certificate</span></span>
<span class="line"><span>  SSLProxyEngine On</span></span>
<span class="line"><span>  SSLProxyVerify None</span></span>
<span class="line"><span>  SSLProxyCheckPeerCN Off</span></span>
<span class="line"><span>  SSLProxyCheckPeerName Off</span></span>
<span class="line"><span>  # keep the host</span></span>
<span class="line"><span>  ProxyPreserveHost On</span></span>
<span class="line"><span>  # static html, js, images, etc. served from coolwsd</span></span>
<span class="line"><span>  # browser is the client part of Collabora Online</span></span>
<span class="line"><span>  ProxyPass           /browser https://127.0.0.1:9980/browser retry=0</span></span>
<span class="line"><span>  ProxyPassReverse    /browser https://127.0.0.1:9980/browser</span></span>
<span class="line"><span>  # WOPI discovery URL</span></span>
<span class="line"><span>  ProxyPass           /hosting/discovery https://127.0.0.1:9980/hosting/discovery retry=0</span></span>
<span class="line"><span>  ProxyPassReverse    /hosting/discovery https://127.0.0.1:9980/hosting/discovery</span></span>
<span class="line"><span> </span></span>
<span class="line"><span>  # Capabilities</span></span>
<span class="line"><span>  ProxyPass           /hosting/capabilities https://127.0.0.1:9980/hosting/capabilities retry=0</span></span>
<span class="line"><span>  ProxyPassReverse    /hosting/capabilities https://127.0.0.1:9980/hosting/capabilities</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  # Main websocket</span></span>
<span class="line"><span>  ProxyPassMatch      &quot;/cool/(.*)/ws$&quot;      wss://127.0.0.1:9980/cool/$1/ws nocanon</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  # Admin Console websocket</span></span>
<span class="line"><span>  ProxyPass           /cool/adminws wss://127.0.0.1:9980/cool/adminws</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  # Download as, Fullscreen presentation and Image upload operations</span></span>
<span class="line"><span>  ProxyPass           /cool https://127.0.0.1:9980/cool</span></span>
<span class="line"><span>  ProxyPassReverse    /cool https://127.0.0.1:9980/cool</span></span>
<span class="line"><span>  # Compatibility with integrations that use the /lool/convert-to endpoint</span></span>
<span class="line"><span>  ProxyPass           /lool https://127.0.0.1:9980/cool</span></span>
<span class="line"><span>  ProxyPassReverse    /lool https://127.0.0.1:9980/cool</span></span>
<span class="line"><span>&lt;/VirtualHost&gt;</span></span>
<span class="line"><span>  </span></span>
<span class="line"><span>&lt;IfModule ssl_module&gt;</span></span>
<span class="line"><span>        Listen 4443</span></span>
<span class="line"><span>&lt;/IfModule&gt;</span></span></code></pre></div><p><strong>Примечание:</strong> Так как мы используем поддомен nextcloud.test.alt, то указываем тот же сертификат, что и для nextcloud. В случае, если используется другой домен, следует сгенерировать отдельный сертификат для нового доменного имени (п.3-п.7).</p><p>Самоподписные сертификаты необходимо добавить в Nextcloud, для покупных сертификатов данное действие не требуется:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># cat /var/lib/ssl/certs/nextcloud.ca-bundle &gt;&gt; /var/www/html/nextcloud/resources/config/ca-bundle.crt</span></span></code></pre></div><p>Затем следует добавить сайт в разрешенные и перезапустить Apache2:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># a2ensite officenextcloud</span></span>
<span class="line"><span># systemctl restart httpd2</span></span></code></pre></div><p><strong>Внимание!</strong> Обязательно необходимо зайти по адресу <a href="https://nextcloud.test.alt:4443/" target="_blank" rel="noreferrer">https://nextcloud.test.alt:4443/</a> и добавить сертификат в исключения браузера.</p><h5 id="веб-сервер-nginx" tabindex="-1">Веб-сервер nginx <a class="header-anchor" href="#веб-сервер-nginx" aria-label="Permalink to &quot;Веб-сервер nginx&quot;">​</a></h5><p>Добавить новый блок <em>server</em> в конфигурацию nginx для nextcloud.test.alt (файл /etc/nginx/sites-available.d/nextcloud.conf):</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>server {</span></span>
<span class="line"><span> listen       4443 ssl;</span></span>
<span class="line"><span> server_name  nextcloud.test.alt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span> ssl_certificate /var/lib/ssl/certs/nextcloud.crt;</span></span>
<span class="line"><span> ssl_certificate_key /var/lib/ssl/private/nextcloud.key;</span></span>
<span class="line"><span></span></span>
<span class="line"><span> # static files</span></span>
<span class="line"><span> location ^~ /browser {</span></span>
<span class="line"><span>   proxy_pass https://127.0.0.1:9980;</span></span>
<span class="line"><span>   proxy_set_header Host $http_host;</span></span>
<span class="line"><span> }</span></span>
<span class="line"><span></span></span>
<span class="line"><span> # WOPI discovery URL</span></span>
<span class="line"><span> location ^~ /hosting/discovery {</span></span>
<span class="line"><span>   proxy_pass https://127.0.0.1:9980;</span></span>
<span class="line"><span>   proxy_set_header Host $http_host;</span></span>
<span class="line"><span> }</span></span>
<span class="line"><span></span></span>
<span class="line"><span> # Capabilities</span></span>
<span class="line"><span> location ^~ /hosting/capabilities {</span></span>
<span class="line"><span>   proxy_pass https://127.0.0.1:9980;</span></span>
<span class="line"><span>   proxy_set_header Host $http_host;</span></span>
<span class="line"><span> }</span></span>
<span class="line"><span></span></span>
<span class="line"><span> # main websocket</span></span>
<span class="line"><span> location ~ ^/cool/(.*)/ws$ {</span></span>
<span class="line"><span>   proxy_pass https://127.0.0.1:9980;</span></span>
<span class="line"><span>   proxy_set_header Upgrade $http_upgrade;</span></span>
<span class="line"><span>   proxy_set_header Connection &quot;Upgrade&quot;;</span></span>
<span class="line"><span>   proxy_set_header Host $http_host;</span></span>
<span class="line"><span>   proxy_read_timeout 36000s;</span></span>
<span class="line"><span> }</span></span>
<span class="line"><span></span></span>
<span class="line"><span> # download, presentation and image upload</span></span>
<span class="line"><span> location ~ ^/(c|l)ool {</span></span>
<span class="line"><span>   proxy_pass https://127.0.0.1:9980;</span></span>
<span class="line"><span>   proxy_set_header Host $http_host;</span></span>
<span class="line"><span> }</span></span>
<span class="line"><span></span></span>
<span class="line"><span> # Admin Console websocket</span></span>
<span class="line"><span> location ^~ /cool/adminws {</span></span>
<span class="line"><span>   proxy_pass https://127.0.0.1:9980;</span></span>
<span class="line"><span>   proxy_set_header Upgrade $http_upgrade;</span></span>
<span class="line"><span>   proxy_set_header Connection &quot;Upgrade&quot;;</span></span>
<span class="line"><span>   proxy_set_header Host $http_host;</span></span>
<span class="line"><span>   proxy_read_timeout 36000s;</span></span>
<span class="line"><span> }</span></span>
<span class="line"><span>}</span></span></code></pre></div><p>Перезапустить nginx:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># systemctl restart nginx</span></span></code></pre></div><h4 id="проверка-конфигурации" tabindex="-1">Проверка конфигурации <a class="header-anchor" href="#проверка-конфигурации" aria-label="Permalink to &quot;Проверка конфигурации&quot;">​</a></h4><p>Рекомендуется выполнить следующие проверки:</p><ol><li>Возможность доступа клиента к пользовательскому интерфейсу Nextcloud. Используйте браузер или запустите команду:<div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ сurl -k https://nextcloud.test.alt/status.php</span></span></code></pre></div>или:<div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ сurl -k https://nextcloud.test.alt/nextcloud/status.php</span></span></code></pre></div></li><li>Возможность доступа клиента к Collabora. Используйте браузер или запустите команду:<div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ сurl -k https://nextcloud.test.alt:4443/hosting/discovery</span></span></code></pre></div>результатом должен быть XML-документ, описывающий возможности клиента WOPI (длинный список различных типов файлов, которые можно открыть). Убедитесь, что содержимое документа отражает правильную схема URL-адресов (https://).</li><li>Возможность доступа из Nextcloud к Collabora:<div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ сurl -k https://nextcloud.test.alt:4443/hosting/discovery</span></span></code></pre></div></li><li>Возможность доступа из Collabora к пользовательскому интерфейсу Nextcloud:<div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ сurl -k https://nextcloud.test.alt/status.php</span></span></code></pre></div></li></ol><p>DNS-имена должны разрешаться как на сервере, так и на клиенте. DNS-имена не должны разрешаться в 127.0.0.1.</p><p>Если для Nextcloud и Collabora используются разные домены, убедитесь, что оба сервера доверяют назначенному TLS-сертификату другой системы, а клиент доверяет TLS-сертификатам как Nextcloud, так и Collabora.</p><h3 id="настроика-collabora-online-в-nextcloud" tabindex="-1">Настройка Collabora Online в Nextcloud <a class="header-anchor" href="#настроика-collabora-online-в-nextcloud" aria-label="Permalink to &quot;Настройка Collabora Online в Nextcloud&quot;">​</a></h3><ol><li>Установить приложение «Nextcloud Office» («Приложения» → «Офис и текст» → «Nextcloud Office» -&gt; «Скачать и включить»).</li><li>Перейти в «Параметры сервера» → «Офис»/«Набор офисных приложений для Nextcloud», выбрать пункт «Использовать собственный сервер». В поле «URL-адрес (и порт) сервера документов Collabora Online» указать адрес сервера Collabora с портом (<a href="https://nextcloud.test.alt:4443/" target="_blank" rel="noreferrer">https://nextcloud.test.alt:4443</a>): <a href="https://www.altlinux.org/%D0%A4%D0%B0%D0%B9%D0%BB:NextcloudCollaboraOnline.png" title="Настройка Collabora Online в Nextcloud" target="_blank" rel="noreferrer"><img src="https://www.altlinux.org/Images.www.altlinux.org/1/18/NextcloudCollaboraOnline.png" alt="Настройка Collabora Online в Nextcloud"></a></li><li>Если сертификат самоподписной или если, например, нет полной цепочки, то необходимо установить отметку «Отключить проверку сертификата (небезопасно)».</li></ol><p>Перейти к папкам и файлам на облачном сервисе. Попробовать открыть любой документ или создать новый — он должен открыться в Collabora:</p><p><a href="https://www.altlinux.org/%D0%A4%D0%B0%D0%B9%D0%BB:Nextcloud_collabora03.png" title="Редактирование документа в браузере" target="_blank" rel="noreferrer"><img src="https://www.altlinux.org/Images.www.altlinux.org/thumb/d/de/Nextcloud_collabora03.png/800px-Nextcloud_collabora03.png" alt="Редактирование документа в браузере"></a></p><p><strong>Примечание:</strong> Проверьте записи «Allow list for WOPI requests»: очистите список для тестирования, затем добавьте IP-адреса по мере необходимости.</p><h3 id="обновление-collabora-docker" tabindex="-1">Обновление Collabora Docker <a class="header-anchor" href="#обновление-collabora-docker" aria-label="Permalink to &quot;Обновление Collabora Docker&quot;">​</a></h3><ol><li>Скачиваем свежий образ:<div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ podman pull collabora/code</span></span></code></pre></div></li><li>Выясняем id контейнера:<div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ podman ps</span></span></code></pre></div></li><li>Останавливаем и удаляем старый контейнер:<div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ podman stop CONTAINER_ID</span></span>
<span class="line"><span>$ podman rm CONTAINER_ID</span></span></code></pre></div></li><li>Запускаем новый контейнер:<div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ podman run -t -d -p 127.0.0.1:9980:9980 -e &#39;aliasgroup=https://nextcloud.test.alt:443&#39; --restart always --cap-add MKNOD --privileged collabora/code</span></span></code></pre></div></li></ol><h2 id="интеграция-с-ldap" tabindex="-1">Интеграция с LDAP <a class="header-anchor" href="#интеграция-с-ldap" aria-label="Permalink to &quot;Интеграция с LDAP&quot;">​</a></h2><p>Nextcloud поставляется с приложением LDAP, позволяющим пользователям LDAP (включая Active Directory и FreeIPA) появляться в списках пользователей Nextcloud.</p><p>На сервере LDAP должна быть настроена учётная запись с правами чтения (DN user). От данной учётной записи будет выполняться подключение к серверу каталогов.</p><p><strong>Примечание:</strong> На сервере Nextcloud должен быть установлен модуль для PHP LDAP [^4]:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># apt-get install php8.2-ldap</span></span>
<span class="line"><span># systemctl restart httpd2</span></span></code></pre></div><p>Для настройки интеграции базы пользователей с LDAP необходимо в списке приложений Nextcloud включить приложение <strong>«LDAP user and group backend»</strong>.</p><p>Ниже показана настройка интеграции с FreeIPA (ipa.example.test).</p><p>Перейти на страницу администрирования Nextcloud: «Параметры сервера» -&gt; «LDAP/AD Интеграция» («LDAP/AD integration»). На этой странице необходимо указать параметры подключения к LDAP.</p><p>На вкладке «Сервер» нужно указать имя хоста LDAP-сервера, порт и ввести учётные данные пользователя:</p><ul><li>сервер: ipa.example.test;</li><li>порт: 389;</li><li>DN пользователя: uid=nextcloud,cn=users,cn=accounts,dc=example,dc=test</li><li>база поиска (Base DN): dc=example,dc=test</li></ul><p><a href="https://www.altlinux.org/%D0%A4%D0%B0%D0%B9%D0%BB:Nextcloudldap01.png" title="Интеграция с LDAP. Вкладка «Сервер»" target="_blank" rel="noreferrer"><img src="https://www.altlinux.org/Images.www.altlinux.org/a/a7/Nextcloudldap01.png" alt="Интеграция с LDAP. Вкладка «Сервер»"></a></p><p><strong>Примечание:</strong> В разных реализациях LDAP могут быть разные требования для указания учётной записи пользователя.</p><p>Для базы поиска пользователей и групп можно нажать кнопку «Определить базу поиска DN» — тогда будет определен корень домена. Или можно ввести самому конкретное подразделение.</p><p>Проверить конфигурацию можно, нажав на кнопку «Проверить базу поиска DN». При ответе «Конфигурация в порядке» можно продолжать настройку.</p><p>На вкладке «Пользователи» («Users») следует указать, какие пользователи LDAP будут отображаться как пользователи Nextcloud. В поле «Фильтр LDAP» указать: (|(objectclass=inetorgperson)(objectclass=person))</p><p><a href="https://www.altlinux.org/%D0%A4%D0%B0%D0%B9%D0%BB:Nextcloudldap02.png" title="Интеграция с LDAP. Вкладка «Пользователи»" target="_blank" rel="noreferrer"><img src="https://www.altlinux.org/Images.www.altlinux.org/9/9c/Nextcloudldap02.png" alt="Интеграция с LDAP. Вкладка «Пользователи»"></a></p><p>На вкладке «Учетные данные» («Login Attributes») следует указать атрибуты, которые можно будет использовать в качестве логина. Например:</p><ul><li>(&amp;(|(objectclass=person))(|(uid=%uid)(|(mailPrimaryAddress=%uid)(mail=%uid)))) — в качестве логина можно использовать имя пользователя или email;</li><li>(&amp;(|(objectclass=inetorgperson)(objectclass=person))(uid=%uid)) — в качестве логина можно использовать имя пользователя.</li></ul><p><a href="https://www.altlinux.org/%D0%A4%D0%B0%D0%B9%D0%BB:Nextcloudldap03.png" title="Интеграция с LDAP. Вкладка «Учетные данные»" target="_blank" rel="noreferrer"><img src="https://www.altlinux.org/Images.www.altlinux.org/c/cb/Nextcloudldap03.png" alt="Интеграция с LDAP. Вкладка «Учетные данные»"></a></p><p>Проверить данную настройку можно, вписав пользователя FreeIPA в поле «Проверить логин» и нажав на кнопку «Проверить настройки».</p><p>На вкладке «Группы» («Groups») необходимо задать фильтры для групп (например, (|(cn=ipausers))):</p><p><a href="https://www.altlinux.org/%D0%A4%D0%B0%D0%B9%D0%BB:Nextcloudldap04.png" title="Интеграция с LDAP. Вкладка «Группы»" target="_blank" rel="noreferrer"><img src="https://www.altlinux.org/Images.www.altlinux.org/c/c4/Nextcloudldap04.png" alt="Интеграция с LDAP. Вкладка «Группы»"></a></p><p>Вкладка «Дополнительно» («Advanced») -&gt; раздел «Настройки каталога» («Directory Settings»):</p><ul><li>«Поле отображаемого имени пользователя» («User Display Name Field»): displayname</li><li>«База дерева пользователей» («Base User Tree»): cn=users,cn=accounts,dc=example,dc=test</li><li>«База дерева групп» («Base Group Tree»): cn=groups,cn=accounts,dc=example,dc=test</li></ul><p><a href="https://www.altlinux.org/%D0%A4%D0%B0%D0%B9%D0%BB:Nextcloudldap05.png" title="Интеграция с LDAP. Вкладка «Дополнительно»" target="_blank" rel="noreferrer"><img src="https://www.altlinux.org/Images.www.altlinux.org/4/4c/Nextcloudldap05.png" alt="Интеграция с LDAP. Вкладка «Дополнительно»"></a></p><p>Вкладка «Эксперт» («Expert»):</p><ul><li>«Атрибут для внутреннего имени» («Internal Username Attribute»): uid</li><li>«UUID-атрибуты для пользователей» («UUID Attribute for Users»): uid</li></ul><p><a href="https://www.altlinux.org/%D0%A4%D0%B0%D0%B9%D0%BB:Nextcloudldap06.png" title="Интеграция с LDAP. Вкладка «Эксперт»" target="_blank" rel="noreferrer"><img src="https://www.altlinux.org/Images.www.altlinux.org/5/51/Nextcloudldap06.png" alt="Интеграция с LDAP. Вкладка «Эксперт»"></a></p><p>Проверить конфигурацию, нажав на кнопку «Проверить конфигурацию».</p><p>Просмотреть список пользователей можно в разделе «Пользователи» (должны подгрузиться пользователи из ldap):</p><p><a href="https://www.altlinux.org/%D0%A4%D0%B0%D0%B9%D0%BB:NextcloudldapUsers.png" title="Пользователи Nextcloud" target="_blank" rel="noreferrer"><img src="https://www.altlinux.org/Images.www.altlinux.org/thumb/9/95/NextcloudldapUsers.png/800px-NextcloudldapUsers.png" alt="Пользователи Nextcloud"></a></p><p>Теперь можно попробовать зайти доменным пользователем используя свой логин и пароль.</p><h2 id="настроика-sso" tabindex="-1">Настройка SSO <a class="header-anchor" href="#настроика-sso" aria-label="Permalink to &quot;Настройка SSO&quot;">​</a></h2><p>Для работы прозрачной аутентификации (SSO) необходимо настроить веб-сервер (<a href="https://www.altlinux.org/Apache2/AD-auth" title="Apache2/AD-auth" target="_blank" rel="noreferrer">Apache</a>, <a href="https://www.altlinux.org/Nginx/AD-auth" title="Nginx/AD-auth" target="_blank" rel="noreferrer">Nginx</a>) и настроить интеграцию c LDAP (см. <a href="https://www.altlinux.org/#%D0%98%D0%BD%D1%82%D0%B5%D0%B3%D1%80%D0%B0%D1%86%D0%B8%D1%8F_%D1%81_LDAP" target="_blank" rel="noreferrer">Интеграция с LDAP</a>).</p><p>Включить приложение <strong>«SSO &amp; SAML authentication»</strong>.</p><p>Далее перейти на страницу администрирования Nextcloud: «Параметры сервера» -&gt; «Подтверждение подлинности SSO и SAML» («SSO &amp; SAML authentication»), выбрать пункт «Использовать переменные окружения», указать переменную <strong>REMOTE_USER</strong>, установить отметку «Разрешайте аутентификацию только в том случае, если учетная запись существует на каком-либо другом бэкэнде (например, LDAP)», чтобы SSO пускал только известных пользователей.</p><p><a href="https://www.altlinux.org/%D0%A4%D0%B0%D0%B9%D0%BB:NextcloudSSO01.png" title="Подтверждение подлинности SSO и SAML" target="_blank" rel="noreferrer"><img src="https://www.altlinux.org/Images.www.altlinux.org/4/49/NextcloudSSO01.png" alt="Подтверждение подлинности SSO и SAML"></a></p><h2 id="примечания" tabindex="-1">Примечания <a class="header-anchor" href="#примечания" aria-label="Permalink to &quot;Примечания&quot;">​</a></h2><p>[^1]: Вместо сервера Арache2 может использоваться сервер Nginx.</p><p>[^2]: При использовании <a href="https://packages.altlinux.org/ru/sisyphus/nginx" target="_blank" rel="noreferrer">nginx</a> необходимые для него пакеты покажет команда apt-cache depends nextcloud-nginx</p><p>[^3]: Версию php необходимо указать свою</p>`,242)]))}const g=s(l,[["render",p]]);export{u as __pageData,g as default};
