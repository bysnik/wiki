import{_ as i,c as a,o as n,ag as p}from"./chunks/framework.D4Vqf8I7.js";const g=JSON.parse('{"title":"Keepalived","description":"","frontmatter":{},"headers":[],"relativePath":"docs/wi/keepalived.md","filePath":"docs/wi/keepalived.md","lastUpdated":1770983055000}'),l={name:"docs/wi/keepalived.md"};function e(t,s,h,k,F,d){return n(),a("div",null,s[0]||(s[0]=[p(`<h1 id="keepalived" tabindex="-1">Keepalived <a class="header-anchor" href="#keepalived" aria-label="Permalink to &quot;Keepalived&quot;">​</a></h1><p><a href="https://www.altlinux.org/Keepalived" target="_blank" rel="noreferrer">https://www.altlinux.org/Keepalived</a><a href="https://selectel.ru/blog/tutorials/what-is-keepalived-and-vip/" target="_blank" rel="noreferrer">https://selectel.ru/blog/tutorials/what-is-keepalived-and-vip/</a></p><p>Keepalived - это программный комплекс обеспечивающий высокую доступность и балансировку нагрузки.</p><p>Keepalived — программный инструмент, предназначенный для обеспечения высокой доступности и отказоустойчивости сетевых сервисов. Он первоначально был разработан для работы с Linux Virtual Server (LVS) для балансировки нагрузки, но его функциональность была расширена, и теперь его часто используют для управления Virtual IP (VIP) адресами и для организации механизма failover (переключение на резервный сервер при сбое основного).</p><p>Keepalived работает на основе протокола VRRP (Virtual Router Redundancy Protocol), который позволяет нескольким серверам обмениваться информацией о состоянии друг друга.</p><p>В случае отказа одного из серверов, другой сервер может автоматически взять на себя его функции, чтобы пользователи не заметили прерывания в работе сервиса. VIP (Virtual IP)</p><p>VIP (Virtual IP Address) — это виртуальный IP-адрес, который не привязан к какому-то конкретному физическому интерфейсу. VIP может быть использован для того, чтобы обеспечить доступ к сервису, который работает на нескольких серверах (например, в кластере). В случае отказа одного сервера, VIP может быть перенесен на другой сервер, обеспечивая непрерывность работы сервиса. Как они работают вместе</p><p>В типичной конфигурации с Keepalived и VIP:</p><pre><code>Один сервер назначается как “главный” или “мастер” и отвечает за управление VIP. Этот сервер обычно активно обслуживает запросы.
Другой сервер или несколько серверов находятся в режиме ожидания и мониторят состояние мастера с помощью Keepalived.
Если мастер сервер выходит из строя, один из резервных серверов автоматически берет на себя VIP и начинает обслуживать запросы.
</code></pre><p>Таким образом, пользователи продолжают получать доступ к сервису без заметных сбоев, даже если один из серверов выходит из строя.</p><h2 id="тестовая-конфигурация" tabindex="-1">Тестовая конфигурация <a class="header-anchor" href="#тестовая-конфигурация" aria-label="Permalink to &quot;Тестовая конфигурация&quot;">​</a></h2><p>Рассмотрим на примере почтовых серверов dovecot с настроенной репликацией <a href="https://www.altlinux.org/Dovecot%5CReplication" title="Dovecot\\Replication" target="_blank" rel="noreferrer">Dovecot\\Replication</a></p><ul><li>balance01 - сервер балансировки №1 IP 192.168.135.235</li><li>balance02 - сервер балансировки №2 IP 192.168.135.236</li><li>dovecot01 - back-end сервер №1 IP 192.168.135.238</li><li>dovecot02 - back-end сервер №2 IP 192.168.135.239</li><li>192.168.135.237 - виртуальный адрес по которому будут доступны back-end серверы</li></ul><h2 id="предварительная-настроика-балансировочных-серверов" tabindex="-1">Предварительная настройка балансировочных серверов <a class="header-anchor" href="#предварительная-настроика-балансировочных-серверов" aria-label="Permalink to &quot;Предварительная настройка балансировочных серверов&quot;">​</a></h2><p>Установим нужный пакет на обоих серверах балансировки:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># apt-get install keepalived</span></span></code></pre></div><p>Изменим параметр ядра <strong>net.ipv4.ip_forward</strong> для этого в файле /etc/net/sysctl.conf добавим:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>net.ipv4.ip_forward = 1</span></span></code></pre></div><p>Для немедленного применения настроек выполним:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># sysctl -p</span></span></code></pre></div><h2 id="настроика-master-сервера" tabindex="-1">Настройка MASTER сервера <a class="header-anchor" href="#настроика-master-сервера" aria-label="Permalink to &quot;Настройка MASTER сервера&quot;">​</a></h2><p>Создадим файл настройки:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># touch /etc/keepalived/keepalived.conf</span></span></code></pre></div><p>Комментарии в файле настройки выделяются знаком &quot;!&quot;<br> Добавим блок <strong>global_defs</strong>:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>global_defs {</span></span>
<span class="line"><span>  ! имя балансера</span></span>
<span class="line"><span>  router_id LVS_1</span></span>
<span class="line"><span>}</span></span></code></pre></div><p>Добавим блок <strong>vrrp_instance</strong> отвечающий за настройку виртуального роутера, для каждого сетевого интерфейса необходимо настроить, по крайне мере один блок vrrp_instance. Вы можете добавить необходимое количество блоков для каждой группы виртуальных IP:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>vrrp_instance DOVECOT {</span></span>
<span class="line"><span>        !Указывает на то что в каком состоянии стартует нода</span></span>
<span class="line"><span>        state MASTER</span></span>
<span class="line"><span>        !Интерфейс для виртуальных IP</span></span>
<span class="line"><span>        interface ens18</span></span>
<span class="line"><span>        !Интерфейс для обмена служебными пакетами между нодами</span></span>
<span class="line"><span>        lvs_sync_daemon_inteface ens18</span></span>
<span class="line"><span>        !Уникальное имя виртуального роутера</span></span>
<span class="line"><span>        virtual_router_id 102</span></span>
<span class="line"><span>        !Приоритет данной ноды относительно других, нода с наибольшим приоритетом переходит в состояние MASTER</span></span>
<span class="line"><span>        priority 150</span></span>
<span class="line"><span>        !Как часто происходит обновление состояния кластера</span></span>
<span class="line"><span>        advert_int 1</span></span>
<span class="line"><span>        !Аутентификация используется для синхронизации между нодами</span></span>
<span class="line"><span>        authentication {</span></span>
<span class="line"><span>                auth_type PASS</span></span>
<span class="line"><span>                auth_pass 12345678</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>        !Виртуальные адреса, которые настроит keealived</span></span>
<span class="line"><span>        virtual_ipaddress {</span></span>
<span class="line"><span>                192.168.135.237/24</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>}</span></span></code></pre></div><p>Далее следует блок настройки виртуального сервера:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>virtual_server 192.168.135.237 22 {</span></span>
<span class="line"><span>        !Частота проверок</span></span>
<span class="line"><span>        delay_loop 6</span></span>
<span class="line"><span>        !Выбираем режим балансировки, для dovecot лучше выбрать Locality-Based Least-Connection</span></span>
<span class="line"><span>        lb_algo lblc</span></span>
<span class="line"><span>        !Выбираем метод перенаправления, в нашем случае Direct Routing</span></span>
<span class="line"><span>        lb_kind DR</span></span>
<span class="line"><span>        protocol TCP</span></span>
<span class="line"><span>        !Описываем back-end серверы</span></span>
<span class="line"><span>        real_server 192.168.135.238 143 {</span></span>
<span class="line"><span>                !Задаем вес сервера</span></span>
<span class="line"><span>                weight 1</span></span>
<span class="line"><span>                !Настраиваем проверку на доступность</span></span>
<span class="line"><span>                TCP_CHECK {</span></span>
<span class="line"><span>                        connect_timeout 3</span></span>
<span class="line"><span>                        connect_port 143</span></span>
<span class="line"><span>                        nb_get_retry 3</span></span>
<span class="line"><span>                        delay_before_retry 3</span></span>
<span class="line"><span>                }</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>        real_server 192.168.135.239 143 {</span></span>
<span class="line"><span>                weight 1</span></span>
<span class="line"><span>                TCP_CHECK {</span></span>
<span class="line"><span>                        connect_timeout 3</span></span>
<span class="line"><span>                        connect_port 143</span></span>
<span class="line"><span>                        nb_get_retry 3</span></span>
<span class="line"><span>                        delay_before_retry 3</span></span>
<span class="line"><span>                }</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>}</span></span></code></pre></div><p>Запустим и добавим сервис keepalived в автозагрузку:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># systemctl enable keepalived</span></span>
<span class="line"><span># systemctl start keepalived</span></span></code></pre></div><p>На MASTER ноде должен добавится виртуальный IP:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># ip a | grep ens18</span></span>
<span class="line"><span>2: ens18: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span></span>
<span class="line"><span>    inet 192.168.135.235/24 brd 192.168.135.255 scope global ens18</span></span>
<span class="line"><span>    inet 192.168.135.237/24 scope global secondary ens18</span></span></code></pre></div><h2 id="настроика-backup-сервера" tabindex="-1">Настройка BACKUP сервера <a class="header-anchor" href="#настроика-backup-сервера" aria-label="Permalink to &quot;Настройка BACKUP сервера&quot;">​</a></h2><p>Файл настройки BACKUP сервера отличается только следующими параметрами:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>router_id LVS_2</span></span>
<span class="line"><span>state BACKUP</span></span>
<span class="line"><span>priority 100</span></span></code></pre></div><h2 id="настроика-back-end-серверов" tabindex="-1">Настройка back-end серверов <a class="header-anchor" href="#настроика-back-end-серверов" aria-label="Permalink to &quot;Настройка back-end серверов&quot;">​</a></h2><p>Необходимо настроить виртуальный IP на обоих back-end серверах. Для этого в файл /etc/net/ifaces/ens18/ipv4address добавим наш виртуальный IP:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>192.168.135.237/24</span></span></code></pre></div><p>Только MASTER сервер балансировки должен отвечать ARP запросы виртуального IP адреса. Необходимо установить параметры ядра <strong>arp_ignore</strong> и <strong>arp_announce</strong> для сетевого интерфейса с виртуальным IP, для того чтобы они не реагировали на ARP запросы для виртуального IP адреса. Для этого для этого в файле /etc/net/sysctl.conf добавим:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>net.ipv4.conf.ens18.arp_ignore = 1</span></span>
<span class="line"><span>net.ipv4.conf.ens18.arp_announce = 2</span></span></code></pre></div><p>Для немедленного применения выполним:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># sysctl -p</span></span></code></pre></div><p>На обоих back-end серверах должен появится виртуальный IP адрес:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># ip a |grep ens18</span></span>
<span class="line"><span>2: ens18: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span></span>
<span class="line"><span>    inet 192.168.135.238/24 brd 192.168.135.255 scope global ens18</span></span>
<span class="line"><span>    inet 192.168.135.237/24 scope global secondary ens18</span></span></code></pre></div><h2 id="настроика-keepalived-и-vip-в-облачнои-платформе" tabindex="-1">Настройка Keepalived и VIP в Облачной платформе <a class="header-anchor" href="#настроика-keepalived-и-vip-в-облачнои-платформе" aria-label="Permalink to &quot;Настройка Keepalived и VIP в Облачной платформе&quot;">​</a></h2><p>Установку и настройку будем проводить на примере серверов Master (192.168.10.10) и Backup (192.168.10.20) с установленной ОС Ubuntu 22.04. В качестве VIP будем использовать адрес 192.168.10.22.</p><p>В большинстве популярных дистрибутивов Linux keepalived доступен в официальных репозиториях и может быть установлен оттуда. Установим и активируем демон Keepalived на двух серверах:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>apt update</span></span>
<span class="line"><span>apt install keepalived</span></span>
<span class="line"><span>systemctl enable keepalived</span></span></code></pre></div><p>После установки необходимо заполнить конфигурационный файл <strong>/etc/keepalived/keepalived.conf: nano /etc/keepalived/keepalived.conf</strong></p><p>Пример конфигурации для сервера Master:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">global_defs</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   router_id</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> MASTER</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vrrp_instance</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> VI_1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    state</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> MASTER</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    interface</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> eth0</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # Замените на имя вашего сетевого интерфейса</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    virtual_router_id</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 51</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    priority</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 101</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # Установите приоритет выше, чем у резервного сервера</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    advert_int</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    authentication</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        auth_type</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> PASS</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        auth_pass</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> your_password</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # Замените на надежный пароль</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    virtual_ipaddress</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        192.168.10.22</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>Пример конфигурации для сервера Backup:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">global_defs</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   router_id</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> BACKUP</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vrrp_instance</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> VI_1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    state</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> BACKUP</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    interface</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> eth0</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # Замените на имя вашего сетевого интерфейса</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    virtual_router_id</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 51</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    priority</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 100</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # Установите приоритет ниже, чем у основного сервера</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    advert_int</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    authentication</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        auth_type</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> PASS</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    auth_pass</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> your_password</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # Должен совпадать с паролем на основном сервере</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    virtual_ipaddress</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        192.168.10.22</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>Описание параметров:</p><ul><li>global_defs: глобальные определения, включая уникальный идентификатор для данного роутера.</li><li>vrrp_instance: определяет VRRP-инстанс (виртуальный маршрутизатор) с именем VI_1. <ul><li>state: устанавливает состояние узла как BACKUP.</li><li>interface: указывает сетевой интерфейс, на котором будет работать VIP.</li><li>virtual_router_id: уникальный идентификатор VRRP для группы виртуальных маршрутизаторов. Должен совпадать с идентификатором на основном сервере.</li><li>priority: приоритет для определения основного и резервного узлов. Установите его ниже, чем у основного сервера.</li><li>advert_int: интервал объявления состояния (в секундах).</li><li>authentication: настройки аутентификации для безопасности. Должен совпадать с паролем на основном сервере.</li><li>virtual_ipaddress: указывает VIP, который будет управляться этим узлом.</li></ul></li></ul><p>Настраивать IP-алиас в любом другом месте, кроме файла конфигурации Keepalived, не требуется. Keepalived автоматически назначит IP-адрес нужному сетевому интерфейсу.</p><p>После внесения изменений в конфигурацию запустим Keepalived для применения настроек:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>systemctl start keepalived</span></span></code></pre></div><p>Проверить статус Keepalived можно командой:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>systemctl status keepalived</span></span></code></pre></div><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@master:~#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> status</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> keepalived</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">●</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> keepalived.service</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> -</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Keepalive</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Daemon</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (LVS </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">and</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> VRRP</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">     Loaded:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> loaded</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (/lib/systemd/system/keepalived.service; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">enabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vendor</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> preset:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> enabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">     Active:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> active</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (running) </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   Main</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> PID:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 798</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (keepalived)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      Tasks:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (limit: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1060</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">     Memory:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 5.1M</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        CPU:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 149ms</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">     CGroup:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /system.slice/keepalived.service</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">             ├─798</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/sbin/keepalived</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --dont-fork</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">             └─803</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/sbin/keepalived</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --dont-fork</span></span></code></pre></div><h2 id="различия-конфигурации-серверов-master-и-backup" tabindex="-1">Различия конфигураций серверов Master и Backup <a class="header-anchor" href="#различия-конфигурации-серверов-master-и-backup" aria-label="Permalink to &quot;Различия конфигураций серверов Master и Backup&quot;">​</a></h2><p>Конфигурации серверов Master и Backup в Keepalived имеют несколько ключевых различий, которые определяют, какой из серверов будет основным, а какой — резервным. Основные различия касаются параметров.</p><h3 id="параметр-state" tabindex="-1">Параметр state <a class="header-anchor" href="#параметр-state" aria-label="Permalink to &quot;Параметр state&quot;">​</a></h3><ul><li>Master: в конфигурации основного сервера этот параметр установлен как MASTER. Это означает, что сервер будет пытаться взять на себя управление VIP при запуске.</li><li>Backup: в конфигурации резервного сервера параметр установлен как BACKUP, что указывает, что сервер будет ждать, пока основной сервер выйдет из строя, прежде чем взять на себя VIP.</li></ul><h3 id="параметр-priority" tabindex="-1">Параметр priority <a class="header-anchor" href="#параметр-priority" aria-label="Permalink to &quot;Параметр priority&quot;">​</a></h3><ul><li>Master: приоритет на основном сервере выше (например, 101), что позволяет ему выигрывать выбор в пользу MASTER-состояния и управлять VIP.</li><li>Backup: на резервном сервере приоритет ниже (например, 100). Это означает, что он станет MASTER только если основной сервер станет недоступным.</li></ul><h3 id="идентификатор-роутера-router-id" tabindex="-1">Идентификатор роутера (router_id): <a class="header-anchor" href="#идентификатор-роутера-router-id" aria-label="Permalink to &quot;Идентификатор роутера (router\\_id):&quot;">​</a></h3><ul><li>Master: идентификатор роутера на Master-сервере может быть указан как MASTER, чтобы подчеркнуть его роль.</li><li>Backup: на Backup-сервере этот идентификатор может быть указан как BACKUP.</li></ul><p>Это помогает различать конфигурации и легко идентифицировать роли серверов.</p><h2 id="проверка-конфигурации" tabindex="-1">Проверка конфигурации <a class="header-anchor" href="#проверка-конфигурации" aria-label="Permalink to &quot;Проверка конфигурации&quot;">​</a></h2><p>Для начала проверим доступность адреса с помощью ICMP-запросов:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@test:~#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ping</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 192.168.10.22</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PING</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 192.168.10.22</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (192.168.10.22) 56(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">84</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) bytes of data.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bytes</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 192.168.10.22:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> icmp_seq=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ttl=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> time=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1.48</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ms</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bytes</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 192.168.10.22:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> icmp_seq=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ttl=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> time=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.274</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ms</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bytes</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 192.168.10.22:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> icmp_seq=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ttl=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> time=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.263</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ms</span></span></code></pre></div><p>Подключимся по ssh, чтобы точно убедиться, что подключение будет выполняться к виртуальной машине Master.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ssh</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root@192.168.10.22</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Welcome</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Ubuntu</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 22.04.4</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> LTS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (GNU/Linux </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">5.15.0-119-generic</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> x86_64</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@master:~#</span></span></code></pre></div><p>Для проверки корректности работы keepalived <a href="https://docs.selectel.ru/cloud/servers/manage/manage-server/#turn-off-server" target="_blank" rel="noreferrer">отключим ВМ</a> Master в панели управления и посмотрим, переключится ли адрес 192.168.10.22 на ВМ Backup.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@test:~#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ping</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 192.168.10.22</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PING</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 192.168.10.22</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (192.168.10.22) 56(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">84</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) bytes of data.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bytes</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 192.168.10.22:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> icmp_seq=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ttl=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> time=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.768</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ms</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bytes</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 192.168.10.22:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> icmp_seq=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ttl=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> time=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.233</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ms</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bytes</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 192.168.10.22:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> icmp_seq=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ttl=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> time=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.302</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ms</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bytes</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 192.168.10.22:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> icmp_seq=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ttl=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> time=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.277</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ms</span></span></code></pre></div><p>При подключении через ssh видим приглашение на сервере Backup:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@test:~#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ssh</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root@192.168.10.22</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@backup:~#</span></span></code></pre></div><p>На сетевом интерфейсе eth0 появился адрес 192.168.20.22, а в логах демона keepalived запись о том, что ВМ является мастером:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@backup:~#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ip</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> a</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">1:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> lo:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  mtu</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 65536</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> qdisc</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> noqueue</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> state</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> UNKNOWN</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> group</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> default</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> qlen</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1000</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    link/loopback</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 00:00:00:00:00:00</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> brd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 00:00:00:00:00:00</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    inet</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 127.0.0.1/8</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> scope</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> host</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> lo</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">       valid_lft</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> forever</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> preferred_lft</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> forever</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    inet6</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ::1/128</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> scope</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> host</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">       valid_lft</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> forever</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> preferred_lft</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> forever</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">2:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> eth0:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  mtu</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1500</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> qdisc</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> fq_codel</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> state</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> UP</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> group</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> default</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> qlen</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1000</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    link/ether</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> fa:16:3e:72:9e:05</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> brd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ff:ff:ff:ff:ff:ff</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    altname</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> enp0s3</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    altname</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ens3</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    inet</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 192.168.10.20/24</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> brd</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 192.168.10.255</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> scope</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> global</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> eth0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">       valid_lft</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> forever</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> preferred_lft</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> forever</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    inet</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 192.168.10.22/32</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> scope</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> global</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> eth0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">       valid_lft</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> forever</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> preferred_lft</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> forever</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    inet6</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> fe80::f816:3eff:fe72:9e05/64</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> scope</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> link</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">       valid_lft</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> forever</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> preferred_lft</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> forever</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@backup:~#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> status</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> keepalived</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">●</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> keepalived.service</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> -</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Keepalive</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Daemon</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (LVS </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">and</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> VRRP</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">     Loaded:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> loaded</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (/lib/systemd/system/keepalived.service; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">enabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vendor</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> preset:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> enabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">     Active:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> active</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (running) since Thu 2024-08-29 07:57:18 UTC; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">6h</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ago</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   Main</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> PID:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1036</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (keepalived)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      Tasks:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (limit: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1060</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">     Memory:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 1.9M</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        CPU:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 1.436s</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">     CGroup:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /system.slice/keepalived.service</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">             ├─1036</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/sbin/keepalived</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --dont-fork</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">             └─1037</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/sbin/keepalived</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --dont-fork</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Aug</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 29</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 07:57:18</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> backup</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Keepalived[1036]:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Starting</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> VRRP</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> child</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> process,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pid=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1037</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Aug</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 29</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 07:57:18</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> backup</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> systemd[1]:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> keepalived.service:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Got</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> notification</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> message</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> PID</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 1037,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> but</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> reception</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> only</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> permitted</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> for</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> main</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> PID</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1036</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Aug</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 29</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 07:57:18</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> backup</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Keepalived_vrrp[1037]:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (/etc/keepalived/keepalived.conf: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Line</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 13</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) Truncating auth_pass to 8 characters</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Aug</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 29</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 07:57:18</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> backup</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Keepalived[1036]:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Startup</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> complete</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Aug</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 29</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 07:57:18</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> backup</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> systemd[1]:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Started</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Keepalive</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Daemon</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (LVS </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">and</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> VRRP</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Aug</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 29</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 07:58:30</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> backup</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Keepalived_vrrp[1037]:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (VI_1) Entering BACKUP STATE</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Aug</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 29</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 14:17:35</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> backup</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Keepalived_vrrp[1037]:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (VI_1) Entering MASTER STATE</span></span></code></pre></div><h2 id="настроика-доступа-во-внешнюю-сеть" tabindex="-1">Настройка доступа во внешнюю сеть <a class="header-anchor" href="#настроика-доступа-во-внешнюю-сеть" aria-label="Permalink to &quot;Настройка доступа во внешнюю сеть&quot;">​</a></h2><p>Если необходим доступ к серверам Master и Backup извне, к VIP адресу можно <a href="https://docs.selectel.ru/cloud/networks/public-ip-addresses/#create-public-ip" target="_blank" rel="noreferrer">подключить публичный адрес</a>.</p><p>В панели управления добавим новый публичный адрес и привяжем его к порту. Для этого перейдем в карточку приватной сети 192.168.10.0/24 на вкладку Порты, добавим новый порт с адресацией 192.168.10.22 и подключим публичный адрес 87.228.8.202.</p><p><img src="https://6ef4e6a1-9d49-47ac-bfed-170f67a815cf.selcdn.net/blog/wp-content/uploads/2024/10/unnamed-1.png" alt=""></p><p>Перезапустим службу Keepalived:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> restart</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> keepalived</span></span></code></pre></div><p>Проверим доступность публичного адреса:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@test:~#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ping</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 87.228.8.202</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PING</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 87.228.8.202</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (87.228.8.202) 56(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">84</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) bytes of data.</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bytes</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 87.228.8.202:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> icmp_seq=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ttl=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">63</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> time=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.520</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bytes</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 87.228.8.202:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> icmp_seq=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ttl=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">63</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> time=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.322</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bytes</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 87.228.8.202:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> icmp_seq=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ttl=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">63</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> time=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.322</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ms</span></span></code></pre></div><p>При подключении через ssh также видим, что keepalived отрабатывает корректно и подключения по умолчанию попадают на сервер Master, а при его недоступности — на Backup.</p><h2 id="заключение" tabindex="-1">Заключение <a class="header-anchor" href="#заключение" aria-label="Permalink to &quot;Заключение&quot;">​</a></h2><p>В этой статье мы рассмотрели настройку Keepalived на двух серверах с использованием одного виртуального IP-адреса (VIP) для обеспечения высокой доступности. Мы использовали адреса из приватной подсети и публичный IP, но вы также можете применять адреса из публичных подсетей.</p><p>Keepalived позволяет автоматически переключать VIP с основного сервера на резервный в случае сбоя, обеспечивая непрерывность работы сервиса. Это решение минимизирует простои и повышает надежность вашей инфраструктуры.</p>`,94)]))}const c=i(l,[["render",e]]);export{g as __pageData,c as default};
