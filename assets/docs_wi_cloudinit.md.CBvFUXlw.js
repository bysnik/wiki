import{_ as i,c as a,o as t,ag as l}from"./chunks/framework.D4Vqf8I7.js";const o=JSON.parse('{"title":"Cloud-init","description":"","frontmatter":{},"headers":[],"relativePath":"docs/wi/cloudinit.md","filePath":"docs/wi/cloudinit.md","lastUpdated":1769604783000}'),n={name:"docs/wi/cloudinit.md"};function e(h,s,p,k,d,c){return t(),a("div",null,s[0]||(s[0]=[l(`<h1 id="cloud-init" tabindex="-1">Cloud-init <a class="header-anchor" href="#cloud-init" aria-label="Permalink to &quot;Cloud-init&quot;">​</a></h1><p><img src="https://habrastorage.org/getpro/habr/upload_files/901/939/bf5/901939bf5394112ee22a760f230c8ab0.png" alt="alt text"></p><p>cloud-init это программа для инициализации виртуальных машин, обычно применяющаяся в облачных платформах. Но использовать cloud-init можно и локально. Примеры конфигурационных файлов - <a href="https://cloudinit.readthedocs.io/en/latest/topics/examples.html" target="_blank" rel="noreferrer">https://cloudinit.readthedocs.io/en/latest/topics/examples.html</a>. Использование с qemu</p><p>Для начала создадим каталог, в котором будем работать, и зайдем в него.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mkdir</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cloud-init-example</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cloud-init-example</span></span></code></pre></div><p>Затем потребуется образ виртуальной машины с поддержкой cloud-init. Например, можно взять cloud образ ALT.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> wget</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> http://ftp.altlinux.org/pub/distributions/ALTLinux/images/Sisyphus/cloud/x86_64/alt-sisyphus-cloud-x86_64.qcow2</span></span></code></pre></div><p>Данные для cloud-init описываются в конфигурационном файле в формате yaml. Пример минимальной конфигурации, задающей только ключ для пользователя root. Вместо &lt;YOUR_PUBLIC_KEY&gt; нужно подставить ваш публичный ключ.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cat</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> user-data.yaml</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#cloud-config</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">users:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  -</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> name:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    ssh_authorized_keys:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      -</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">YOUR_PUBLIC_KE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Y</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span></code></pre></div><p>Для преобразования конфигурационного файла в метаданные потребуется программа cloud-localds из пакета cloud-utils.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">apt-get</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cloud-utils</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cloud-localds</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> my-seed.img</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> user-data.yaml</span></span></code></pre></div><p>Для использования kvm пользователь должен быть в группе vmusers.</p><p>Осталось только запустить виртуальную машину.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> qemu</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -machine</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> accel=kvm</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -m</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 2G</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -cpu</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> host</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -smp</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -drive</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> file=alt-sisyphus-cloud-x86_64.qcow2,if=virtio</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -drive</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> file=my-seed.img,if=virtio,format=raw,force-share=on,read-only=on</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -daemonize</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -display</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> none</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -nic</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> user,hostfwd=tcp::22222-:22</span></span></code></pre></div><p>И зайти по ssh. Может потребоваться подождать некоторое время, пока машина будет загружена и инициализирована.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ssh</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root@localhost</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -p</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 22222</span></span></code></pre></div><div class="tip custom-block"><p class="custom-block-title">Примечание</p><p>Начиная с версии 24.4.1 необходимо учесть новую логику запуска служб <code>cloud-init</code> в случае самостоятельной инсталяции пакета (При обновлении пакета <code>cloud-init</code> функционал настраивается автоматически). Сначала должна отработать служба <code>cloud-init-main.service</code>, далее - остальные.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> enable</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --now</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cloud-init-main.service</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> enable</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --now</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cloud-init-local.service</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cloud-init-network.service</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cloud-config.service</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cloud-final.service</span></span></code></pre></div><p>Добавлена новая служба <code>cloud-init-main.service</code>, которая отвечает за настройку сокетов для работы остальных <code>cloud-init</code> служб. В более ранних версиях запускалась служба <code>cloud-init.service</code>, которая теперь переименована в службу <code>cloud-init-network.service</code>.</p><p>В случае наличия некорректного запуска служб по старому принципу из новой версии пакета простой способ все починить (не забывая добавить недостающие службы в автозапуск при перезагрузке):</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> stop</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cloud-init-local.service</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cloud-init-network.service</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cloud-config.service</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cloud-final.service</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cloud-init-main.service</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> start</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cloud-init-main.service</span></span></code></pre></div><p>секунду подождать</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> start</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cloud-init-local.service</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cloud-init-network.service</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cloud-config.service</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cloud-final.service</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cloud-init</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> clean</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --logs</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --reboot</span></span></code></pre></div><p>Cистема перезагрузится и можно проверить результат:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> status</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cloud-init-local.service</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cloud-init-network.service</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cloud-config.service</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cloud-final.service</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cloud-init-main.service</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cloud-init</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> status</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --long</span></span></code></pre></div></div>`,17)]))}const r=i(n,[["render",e]]);export{o as __pageData,r as default};
