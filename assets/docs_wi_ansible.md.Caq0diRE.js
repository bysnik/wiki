import{_ as a,c as i,o as n,ag as p}from"./chunks/framework.D4Vqf8I7.js";const g=JSON.parse('{"title":"Ansible","description":"","frontmatter":{},"headers":[],"relativePath":"docs/wi/ansible.md","filePath":"docs/wi/ansible.md","lastUpdated":1769158274000}'),l={name:"docs/wi/ansible.md"};function h(t,s,e,k,d,r){return n(),i("div",null,s[0]||(s[0]=[p(`<h1 id="ansible" tabindex="-1">Ansible <a class="header-anchor" href="#ansible" aria-label="Permalink to &quot;Ansible&quot;">​</a></h1><p><img src="https://habrastorage.org/getpro/habr/upload_files/81b/5e2/9f1/81b5e29f12b41ba26dff6cdd05848a5b.webp" alt=""></p><p>Ansible — система управления конфигурациями, написанная на Python, с использованием декларативного языка разметки для описания конфигураций. Используется для автоматизации настройки и развертывания программного обеспечения. Обычно используется для управления Linux-узлами, но Windows также поддерживается. Поддерживает работу с сетевыми устройствами, на которых установлен Python версии 2.4 и выше по SSH или WinRM соединению.</p><p><a href="https://www.altlinux.org/Ansible" target="_blank" rel="noreferrer">https://www.altlinux.org/Ansible</a></p><p><a href="https://docs.ansible.com/projects/ansible/latest/collections/index.html" target="_blank" rel="noreferrer">https://docs.ansible.com/projects/ansible/latest/collections/index.html</a></p><h2 id="быстрыи-старт" tabindex="-1">Быстрый старт <a class="header-anchor" href="#быстрыи-старт" aria-label="Permalink to &quot;Быстрый старт&quot;">​</a></h2><h3 id="установка-на-сервер" tabindex="-1">Установка на сервер: <a class="header-anchor" href="#установка-на-сервер" aria-label="Permalink to &quot;Установка на сервер:&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">apt-get</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ansible</span></span></code></pre></div><h3 id="установка-на-клиенты" tabindex="-1">Установка на клиенты: <a class="header-anchor" href="#установка-на-клиенты" aria-label="Permalink to &quot;Установка на клиенты:&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">apt-get</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> python</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> python-module-yaml</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> python-module-jinja2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> python-modules-json</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> python-modules-distutils</span></span></code></pre></div><p>На клиенте должен быть настроен ключевой (безпарольный) доступ по ssh к пользователю root на клиенте пользователем, который будет работать с ansible на сервере (не root).</p><p>Все дальнейшие действия производим на сервере.</p><h3 id="редактируем-фаил-etc-ansible-hosts-это-фаил-которыи-содержит-списки-хостов-и-группы-этих-хостов" tabindex="-1">Редактируем файл <code>/etc/ansible/hosts</code> - это файл, который содержит списки хостов и группы этих хостов: <a class="header-anchor" href="#редактируем-фаил-etc-ansible-hosts-это-фаил-которыи-содержит-списки-хостов-и-группы-этих-хостов" aria-label="Permalink to &quot;Редактируем файл \`/etc/ansible/hosts\` - это файл, который содержит списки хостов и группы этих хостов:&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>[all:vars]</span></span>
<span class="line"><span>ansible_user=root</span></span>
<span class="line"><span>ansible_python_interpreter=/usr/bin/python3</span></span>
<span class="line"><span></span></span>
<span class="line"><span>ниже указываем хосты</span></span></code></pre></div><p>Пример файла hosts:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>[all:vars]</span></span>
<span class="line"><span>ansible_user=root</span></span>
<span class="line"><span>ansible_python_interpreter=/usr/bin/python3</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[group1]</span></span>
<span class="line"><span>192.168.100.101</span></span>
<span class="line"><span>192.168.100.102</span></span>
<span class="line"><span>192.168.100.103</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[servers]</span></span>
<span class="line"><span>altsrv1.courses.alt</span></span>
<span class="line"><span>altsrv2.courses.alt</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[wks]</span></span>
<span class="line"><span>altwks1 ansible_ssh_port=2221 ansible_ssh_host=192.168.100.201</span></span>
<span class="line"><span>altwks2 ansible_ssh_port=2221 ansible_ssh_host=192.168.100.202</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[alt:children]</span></span>
<span class="line"><span>servers</span></span>
<span class="line"><span>wks</span></span></code></pre></div><h3 id="использование-ad-hoc-команд-в-ansible" tabindex="-1">Использование ad-hoc команд в Ansible <a class="header-anchor" href="#использование-ad-hoc-команд-в-ansible" aria-label="Permalink to &quot;Использование ad-hoc команд в Ansible&quot;">​</a></h3><p>Проверяем связь с клиентом с помощью модуля ping в интерактивном режиме:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ansible</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -m</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ping</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> servers</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">altsrv1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SUCCESS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;changed&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;ping&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;pong&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">altsrv2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SUCCESS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;changed&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;ping&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;pong&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>где servers - это группа хостов из файла <code>/etc/ansible/hosts</code></p><p>Пример. Выполнение команды на управляемых узлах</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ansible</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -i</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> hosts</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -m</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> shell</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -a</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;uname -a&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> servers</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">altsrv2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CHANGED</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rc</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &gt;&gt;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Linux</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> altsrv2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 5.10.82-std-def-alt1</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> #1 SMP Fri Dec 3 14:49:25 UTC 2021 x86_64</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">GNU/Linux</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">altsrv1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CHANGED</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rc</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &gt;&gt;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Linux</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> altsrv1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 5.10.82-std-def-alt1</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> #1 SMP Fri Dec 3 14:49:25 UTC 2021 x86_64</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">GNU/Linux</span></span></code></pre></div><p>Пример. Удаление файла</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ansible</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -m</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> file</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -a</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;name=/etc/nologin state=absent&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> all</span></span></code></pre></div><h3 id="создание-хеша-пароля" tabindex="-1">Создание хеша пароля: <a class="header-anchor" href="#создание-хеша-пароля" aria-label="Permalink to &quot;Создание хеша пароля:&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mkpasswd</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">passwor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">d</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span></code></pre></div><p>Получаем строку.</p><p>Далее используем ansible-vault:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ansible-vault</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> encrypt_string</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;ранее полученный хэш&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">New</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Vault</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> password:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Confirm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> New</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Vault</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> password:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vault</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    $ANSIBLE_VAULT;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">1.1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">AES256</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    65366666616436396133363165346432623166616161383037613833393438363039336438386265</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    6633613030303565316431336531313261366532376336640a623861316166643730323833666263</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    65333534303663363066323832376231616261363636616330366634616334663234666330623934</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    3764343932663632350a393563366331376630666239386163656531343936616438316434343738</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    36636533366433353939666333313538633539383365643766663563616534623863396166356530</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    63306638373134303961353364333131386361653064306364346265313334353436303239373838</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    62346136656161653430383730663661393830313430343539366663383431626365633465376436</span></span></code></pre></div><p>И теперь весь этот блок, начиная с <code>!vault |</code> необходимо использовать в ансибле</p><h2 id="полезные-рецепты-с-альтвики" tabindex="-1">Полезные рецепты с Альтвики <a class="header-anchor" href="#полезные-рецепты-с-альтвики" aria-label="Permalink to &quot;Полезные рецепты с Альтвики&quot;">​</a></h2><p>Рецепты применяются командой:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>ansible-playbook &lt;имя файла&gt;</span></span></code></pre></div><h3 id="прописывание-репозитория" tabindex="-1">Прописывание репозитория <a class="header-anchor" href="#прописывание-репозитория" aria-label="Permalink to &quot;Прописывание репозитория&quot;">​</a></h3><p>Файл: /etc/ansible/playbooks/repo.yml</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>- hosts: local</span></span>
<span class="line"><span>  remote_user: root</span></span>
<span class="line"><span>  tasks: </span></span>
<span class="line"><span>  - name: Remove all repositories</span></span>
<span class="line"><span>    shell: apt-repo rm all</span></span>
<span class="line"><span>  - name: Add official mirror</span></span>
<span class="line"><span>    shell: apt-repo add http://10.10.3.77/repo/p8</span></span>
<span class="line"><span>  - name: Add official mirror with arepo</span></span>
<span class="line"><span>    shell: apt-repo add &#39;rpm http://10.10.3.77/repo/p8 x86_64-i586 classic&#39;</span></span>
<span class="line"><span>  - name: Add extra repository </span></span>
<span class="line"><span>    shell: apt-repo add &#39;rpm http://10.10.3.77/repo/extra x86_64 extra&#39;</span></span></code></pre></div><p><strong>Примечание:</strong> Используется <a href="http://docs.ansible.com/ansible/latest/modules/shell_module.html" target="_blank" rel="noreferrer">модуль shell</a> и программа apt-repo.</p><h3 id="установка-пакета" tabindex="-1">Установка пакета <a class="header-anchor" href="#установка-пакета" aria-label="Permalink to &quot;Установка пакета&quot;">​</a></h3><p>Файл: /etc/ansible/playbooks/install-ifcplugin.yml</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>- hosts: local</span></span>
<span class="line"><span>  remote_user: root</span></span>
<span class="line"><span>  tasks:</span></span>
<span class="line"><span>  - name: Update cache and install ifcplugin</span></span>
<span class="line"><span>    apt_rpm:</span></span>
<span class="line"><span>      name: ifcplugin</span></span>
<span class="line"><span>      state: present</span></span>
<span class="line"><span>      update_cache: yes</span></span></code></pre></div><h3 id="обновление-системы" tabindex="-1">Обновление системы <a class="header-anchor" href="#обновление-системы" aria-label="Permalink to &quot;Обновление системы&quot;">​</a></h3><p>С версии ansible-2.9.27-alt2 и ansible-core-2.14.2-alt1:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>- hosts: local</span></span>
<span class="line"><span>  remote_user: root</span></span>
<span class="line"><span>  gather_facts: no</span></span>
<span class="line"><span>  tasks:</span></span>
<span class="line"><span>  - name: Update cache</span></span>
<span class="line"><span>    apt_rpm:</span></span>
<span class="line"><span>      update_cache: true</span></span>
<span class="line"><span>  - name: Upgrade system</span></span>
<span class="line"><span>    apt_rpm:</span></span>
<span class="line"><span>      dist_upgrade: true</span></span>
<span class="line"><span>  - name: Upgrade kernel</span></span>
<span class="line"><span>    apt_rpm:</span></span>
<span class="line"><span>      update_kernel: true</span></span>
<span class="line"><span>  - name: Clean package cache</span></span>
<span class="line"><span>    apt_rpm:</span></span>
<span class="line"><span>      clean: true</span></span></code></pre></div><p>Или всё в одном:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>- hosts: local</span></span>
<span class="line"><span>  remote_user: root</span></span>
<span class="line"><span>  gather_facts: no</span></span>
<span class="line"><span>  tasks:</span></span>
<span class="line"><span>  - name: Upgrade system</span></span>
<span class="line"><span>    apt_rpm:</span></span>
<span class="line"><span>      update_cache: true</span></span>
<span class="line"><span>      dist_upgrade: true</span></span>
<span class="line"><span>      update_kernel: true</span></span>
<span class="line"><span>      clean: true</span></span></code></pre></div><p><strong>Примечание:</strong> Используется <a href="https://docs.ansible.com/ansible/latest/collections/community/general/apt_rpm_module.html" target="_blank" rel="noreferrer">модуль apt_rpm</a>.</p><h4 id="ссылки" tabindex="-1">Ссылки <a class="header-anchor" href="#ссылки" aria-label="Permalink to &quot;Ссылки&quot;">​</a></h4><ul><li><a href="http://habr.com/ru/post/508762/" target="_blank" rel="noreferrer">Основы Ansible, без которых ваши плейбуки — комок слипшихся макарон</a></li></ul><hr><p>использование плагина <a href="https://docs.ansible.com/ansible/latest/collections/community/general/nmap_inventory.html" target="_blank" rel="noreferrer">nmap</a> в связке с плагином <a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/constructed_inventory.html" target="_blank" rel="noreferrer">constructed</a>. При запуске он опрашивает указанные подсети и формирует список хостов для применения плейбуков или ролей, а потом делает свои грязные делишки на отобранные по правилам хосты.</p><p>Использование ANSIBLE VAULT Назначение:</p><ul><li>Шифрование данных</li><li>Хранение шифрованных данных</li><li>Расшифровка данных только в момент использования этих данных Работа с ansible-vault в интерактивном режиме:</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ansible-vault</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> create</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> decrypt</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> edit</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> view</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> encrypt</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> encrypt_string</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rekey</span></span></code></pre></div><p>Шифрование отдельных строк:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ansible-vault</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> encrypt_string</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;password&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">New</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Vault</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> password:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Confirm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> New</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Vault</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> password:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vault</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$ANSIBLE_VAULT;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">1.1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">AES256</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    36616364663239636230386638643139383237326533363236323339666162323163376565313138</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    3333636130646636363639363530643364656534336338370a383131306136353337303261366430</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    61366633656262373236333434353539633631366533623630373032366461346630636635313235</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    6631393939646632360a656430626338336533376437646232323161653939383739353564353934</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    6338</span></span></code></pre></div><p>Применение полученного результата, создадим плейбук в котором используются зашифрованная строка:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">play1.yml</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">---</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Получим пароль</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">hosts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">localhost</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">gather_facts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">no</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">vars</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">password</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!vault</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">$ANSIBLE_VAULT;1.1;AES256</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    36616364663239636230386638643139383237326533363236323339666162323163376565313138</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    3333636130646636363639363530643364656534336338370a383131306136353337303261366430</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    61366633656262373236333434353539633631366533623630373032366461346630636635313235</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    6631393939646632360a656430626338336533376437646232323161653939383739353564353934</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    6338</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">tasks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">debug</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">debug</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">msg</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Пароль: {{ password }} &quot;</span></span></code></pre></div><p>Выполним полученный плейбук:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ansible-play</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> play1.yml</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Получим ошибку, т.к. не указан пароль для расшифровки</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ansible-playbook</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> play1.yml</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --ask-vault-password</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PLAY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [Получим </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">пароль]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">******************************************************************************</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">TASK</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [debug]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">***************************************************************************************</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ok:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [localhost] =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;msg&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Пароль: password &quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PLAY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> RECAP</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*****************************************************************************************</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">localhost</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> :</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ok=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> changed=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> unreachable=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">failed</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> skipped</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rescued</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ignored</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Создание</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> строки</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> пригодной</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> для</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> встраивание</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> в</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> плейбуки:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ansible-vault</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> encrypt_string</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;password&#39;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --name</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;user_password&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">user_password:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> !vault</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$ANSIBLE_VAULT;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">1.1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">AES256</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    63366162373537346533316265303361303766393938333439633965613866623130376330616531</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    3664323366666234363636656264333133653562396135310a633237613966343065643736363733</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    34313737643732616662356539383130373962356363333366353834366163313030663563623037</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    3633663230373636330a326262353464323334363632323639313633313531333164343664376438</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    3433</span></span></code></pre></div><p>Создание хранилища в виде файла:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ansible-vault</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> create</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /tmp/vault1.yml</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">New</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Vault</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> password:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Confirm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> New</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Vault</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> password:</span></span></code></pre></div><p>Запускается редактор по-умолчанию для редактирование файла (vim). Просмотр результата:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cat</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /tmp/vault1.yml</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$ANSIBLE_VAULT;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">1.1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">AES256</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    31306565313730343431623364613939373162323163643238613137323261653139623062646438</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    3764383630306665666439663530613538363035386232640a643265356263303133623037363234</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    33326336386338613064383732663664396436643864303137653966376139643465353566313330</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    3662323665636463630a653637376438326164306536313638653633333930626262636362353962</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    36613462333261346633323464646437316464343034353830316437373431643765</span></span></code></pre></div><p>Просмотр дешифрованного содержимого файла:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ansible-vault</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> view</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /tmp/vault1.yml</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Vault</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> password:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">user_password:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> netlab123</span></span></code></pre></div><p>Использование шифрованных файлов в плейбуке: play1.yml:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">---</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Получим пароль</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">hosts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">localhost</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">vars_files</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/tmp/vault1.yml&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">gather_facts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">no</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">tasks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">debug</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">debug</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">msg</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Пароль: {{ user_password }}&quot;</span></span></code></pre></div><p>Результат:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ansible-playbook</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> play1.yml</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --ask-vault-password</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Vault</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> password:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PLAY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [Получим </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">пароль]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">******************************************************************************</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">TASK</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [debug]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">***************************************************************************************</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ok:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [localhost] =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;msg&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Пароль: netlab123&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PLAY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> RECAP</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*****************************************************************************************</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">localhost</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> :</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ok=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> changed=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> unreachable=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">failed</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> skipped</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rescued</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ignored</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">0</span></span></code></pre></div><p>Редактирование зашифрованного содержимого файла:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> EDITOR=nano</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ansible-vault</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> edit</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /tmp/vault1.yml</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Данные в виде словаря</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">passwords:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">user1:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">password:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> netlab123</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">user2:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">password:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> netlab123</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Изменённый</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> плейбук:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">play1.yml:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">---</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> name:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Получим</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> пароль</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">hosts:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> localhost</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vars_files:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;/tmp/vault1.yml&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">gather_facts:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> no</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tasks:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> name:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> debug</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">debug:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">msg:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Пароль пользователя {{ item.key }} :</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">{{ item.value.password }}&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">loop:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;{{ passwords | dict2items }}&quot;</span></span></code></pre></div><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ansible-playbook</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> play1.yml</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --ask-vault-password</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Vault</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> password:</span></span></code></pre></div><p>Шифрованние/дешифрование готового файла:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> vim</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> user-passwords.yml</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # создаём файл</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ansible-vault</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> encrypt</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> user-passwords.yml</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # шифрование файла</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cat</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> user-passwords.yml</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # просмотр результата</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ansible-vault</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> view</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> user-passwords.yml</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # просмотр</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ansible-vault</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> decrypt</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> user-passwords.yml</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # шифрование файла</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ansible-vault</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> encrypt</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> user-passwords.yml</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # зашифруем снова</span></span></code></pre></div><p>Шифрование (+ хранение) файла:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cp</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ~/.ssh/id_rsa</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> id_rsa.encrypted</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ansible-vault</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> encrypt</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> id_rsa.encrypted</span></span></code></pre></div><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">Создадим плейбук для копирования зашифрованного файла</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">copy-file.yml</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">---</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Соединяемся с другим узлом</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">hosts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">remotehost</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">gather_facts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">no</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">become</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">tasks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Копирование файла на удалённый сервер</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">copy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">src</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">id_rsa.encrypted</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">~/.ssh/remote_key</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">mode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;0600&#39;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">Пример использования</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">use-user.yml</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">---</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Соединяемся с другим узлом</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">hosts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">remotehost</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">vars_files</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;user-passwords.yml&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">gather_facts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">no</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">tasks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Установим учётную запись и пароль для соединения</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">set_fact</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">ansible_user</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;{{ item.key }}&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">ansible_password</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;{{ item.value.password }}&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">with_items</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;{{ passwords | dict2items }}&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">when</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">item.key == &quot;user1&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Посмотрим в какие группы входит пользователь</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">shell</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/usr/bin/id</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">register</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">result</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Посмотрим результат</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">debug</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">msg</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Пользователь {{ ansible_user }} входит в группы</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">{{result.stdout}}&quot;</span></span></code></pre></div><p>Потребуется sshpass:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># apt-get install sshpass</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ansible-playbook</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> use-user.yml</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --ask-vault-password</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Vault</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> password:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> no_log:</span></span></code></pre></div><p>Использование ansible-vault без введения пароля:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ANSIBLE_VAULT_PASSWORD_FILE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">--vault-password-file</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ansible-playbook</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> use-user.yml</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --vault-password-file=</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> chmod</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> +x</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">vault-password-fil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span></code></pre></div><p>say_password:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#!/bin/sh</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> U2FsdGVkX1+7Gd8IBqVzGfDmsrbRcT2K0SNZSq8158o=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> openssl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> aes-</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">256-cbc</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -d</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -a</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -pass</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pass:somepassword</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> 2&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/dev/null</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Использование</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ansible-vault</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> в</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ролях:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> r1/vars</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> открытая</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> часть:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> закрытая</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> часть:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">passwords.yml:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">---</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># vars file for r1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">passwords:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">user1:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">password:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;netlab123&quot;</span></span></code></pre></div><p>Шифруем файл «закрытой части»:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ansible-vault</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> encrypt</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> passwords.yml</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">New</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Vault</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> password:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Confirm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> New</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Vault</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> password:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Encryption</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> successful</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Изменяем</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> файл</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> с</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> задачами:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ../tasks/</span></span></code></pre></div><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">main.yml</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">---</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># tasks file for r1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Создаём пользователя без пароля</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">user</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;{{ item.key }}&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">append</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;{{ item.value.append }}&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">groups</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;{{ item.value.groups }}&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">loop</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;{{ users | dict2items }}&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Добавим файл с паролем</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">include_vars</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">passwords.yml</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Создаём пароль для пользователя</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">user</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;{{ item.key }}&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">password</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;{{ item.value.password |</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">password_hash(&#39;sha512&#39;) }}&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">loop</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;{{ passwords | dict2items }}&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">no_log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span></code></pre></div><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ansible-playbook</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> r1task.yml</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --vault-password-file=say_password</span></span></code></pre></div><p>Использование нескольких хранилищ:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cat</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ~/.ansible/inventory.ini</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> EDITOR=nano</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ansible-vault</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> create</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --vault-id</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> become105@prompt</span></span></code></pre></div><p>/home/sysadmin/.ansible/192.168.100.105.yml</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- @</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">prompt</span></span></code></pre></div><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cat</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /home/sysadmin/.ansible/192.168.100.105.yml</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$ANSIBLE_VAULT;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">1.2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">AES256</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">become105</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> vim</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> become105</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">r1task.yml:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vars_files:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;/home/sysadmin/.ansible/192.168.100.105.yml&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ansible-playbook</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> r1task.yml</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --vault-password-file=say_password</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">--vault-id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">become105</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">--vault-password-file</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">--vault-id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span></span></code></pre></div><div class="tip custom-block"><p class="custom-block-title">TIP</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Система управления конфигурациями</span></span>
<span class="line"><span>Ansible</span></span>
<span class="line"><span>Основы Ansible</span></span>
<span class="line"><span>Об Ansible</span></span>
<span class="line"><span>• Ansible</span></span>
<span class="line"><span>• Декларативный синтаксис</span></span>
<span class="line"><span>• Отличительные особенности Ansible</span></span>
<span class="line"><span>◦ не требует агентского ПО</span></span>
<span class="line"><span>◦ декларативный синтаксис</span></span>
<span class="line"><span>◦ push-модель управления</span></span>
<span class="line"><span>◦ паралельное выполнение изменений</span></span>
<span class="line"><span>Назначение</span></span>
<span class="line"><span>• Настройка</span></span>
<span class="line"><span>• Множество управляемых узлов</span></span>
<span class="line"><span>• Параметризация</span></span>
<span class="line"><span>• Сборка фактов</span></span>
<span class="line"><span>Архитектура</span></span>
<span class="line"><span>• Управляющий хост</span></span>
<span class="line"><span>• Управляемые хосты (targets)</span></span>
<span class="line"><span>• Сетевое взаимодействие</span></span>
<span class="line"><span>• Модули</span></span>
<span class="line"><span>• Задание (tasks)</span></span>
<span class="line"><span>Архитектура Ansible</span></span></code></pre></div><p><img src="https://habrastorage.org/getpro/habr/upload_files/5f2/284/e80/5f2284e805ee0ad18b680351866a6621.png" alt=""></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Установка в ОС Альт</span></span>
<span class="line"><span>Управляющий узел</span></span>
<span class="line"><span>$ apt-get install ansible</span></span>
<span class="line"><span>/etc/ansible/ansible.cfg</span></span>
<span class="line"><span>~/.ansible.cfg</span></span>
<span class="line"><span>Подключение к управлемым узлам</span></span>
<span class="line"><span>• ssh root@host</span></span>
<span class="line"><span>$ ssh-keygen</span></span>
<span class="line"><span>$ ssh-copy-id root@&lt;host&gt;</span></span>
<span class="line"><span>• ssh user@host</span></span>
<span class="line"><span>Управляемые узлы</span></span>
<span class="line"><span>$ apt-get install python3 python3-module-yaml python3-module-jinja2 python3-</span></span>
<span class="line"><span>module-jsonlib</span></span>
<span class="line"><span>Файл инвентаризации (Inventory)</span></span>
<span class="line"><span>/etc/ansible/hosts</span></span>
<span class="line"><span>$ ansible -i ./hosts</span></span>
<span class="line"><span>$ ANSIBLE_HOSTS=./hosts</span></span>
<span class="line"><span>Структура файлов инвентаризации</span></span>
<span class="line"><span>[all:vars]</span></span>
<span class="line"><span>ansible_user=root</span></span>
<span class="line"><span>ansible_python_interpreter=/usr/bin/python3</span></span>
<span class="line"><span>mail.domain.alt</span></span>
<span class="line"><span>[webservers]</span></span>
<span class="line"><span>www.domain.alt</span></span>
<span class="line"><span>private-web.domain.alt</span></span>
<span class="line"><span>[dbases]</span></span>
<span class="line"><span>db[1:3].domain.alt</span></span>
<span class="line"><span>all:</span></span>
<span class="line"><span>hosts:</span></span>
<span class="line"><span>mail.domain.alt</span></span>
<span class="line"><span>children:</span></span>
<span class="line"><span>webservers:</span></span>
<span class="line"><span>host:</span></span>
<span class="line"><span>www.domain.alt</span></span>
<span class="line"><span>private-web.domain.alt</span></span>
<span class="line"><span>dbases:</span></span>
<span class="line"><span>hosts:</span></span>
<span class="line"><span>db[1:3].domain.alt</span></span>
<span class="line"><span>Хосты в файле инвенторизации</span></span>
<span class="line"><span>Группы файла инвентаризации</span></span>
<span class="line"><span>Переменные файла инвентаризации</span></span>
<span class="line"><span>Пример файла инвентаризации</span></span>
<span class="line"><span>[all:vars]</span></span>
<span class="line"><span>ansible_user=root</span></span>
<span class="line"><span>ansible_python_interpreter=/usr/bin/python3</span></span>
<span class="line"><span>[group1]</span></span>
<span class="line"><span>192.168.100.101</span></span>
<span class="line"><span>192.168.100.102</span></span>
<span class="line"><span>192.168.100.103</span></span>
<span class="line"><span>[servers]</span></span>
<span class="line"><span>altsrv1.courses.alt</span></span>
<span class="line"><span>altsrv2.courses.alt</span></span>
<span class="line"><span>[wks]</span></span>
<span class="line"><span>altwks1 ansible_ssh_port=2221 ansible_ssh_host=192.168.100.201</span></span>
<span class="line"><span>altwks2 ansible_ssh_port=2221 ansible_ssh_host=192.168.100.202</span></span>
<span class="line"><span>[alt:children]</span></span>
<span class="line"><span>servers</span></span>
<span class="line"><span>wks</span></span>
<span class="line"><span>Динамическая инвентаризация</span></span>
<span class="line"><span>Дополнительное чтение</span></span>
<span class="line"><span>• https://habr.com/ru/post/509938/</span></span>
<span class="line"><span>Использование ad-hoc команд в Ansible</span></span>
<span class="line"><span>Ad-hoc команды</span></span>
<span class="line"><span>• Типичное применение</span></span>
<span class="line"><span>◦ управление службами и процессами</span></span>
<span class="line"><span>◦ проверка содержимого файлов журналов</span></span>
<span class="line"><span>◦ проверка установленного ПО</span></span>
<span class="line"><span>◦ проверка системных параметров и данных производительности</span></span>
<span class="line"><span>◦ знакомство с новыми модулями</span></span>
<span class="line"><span>Синтаксис команды ansible</span></span>
<span class="line"><span>$ ansible [-i inventory ] \\</span></span>
<span class="line"><span>[-m module] [-a &quot;params&quot;] \\</span></span>
<span class="line"><span>[ -b ] \\</span></span>
<span class="line"><span>[all|group|host]</span></span>
<span class="line"><span>• -i inventory-file</span></span>
<span class="line"><span>• -m module</span></span>
<span class="line"><span>• -a “param1=val param2=val”</span></span>
<span class="line"><span>• -b</span></span>
<span class="line"><span>• all|group|host</span></span>
<span class="line"><span>Пример. ping средствами Ansible</span></span>
<span class="line"><span>$ ansible -i hosts -m ping servers</span></span>
<span class="line"><span>altsrv1 | SUCCESS =&gt; {</span></span>
<span class="line"><span>&quot;changed&quot;: false,</span></span>
<span class="line"><span>&quot;ping&quot;: &quot;pong&quot;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>altsrv2 | SUCCESS =&gt; {</span></span>
<span class="line"><span>&quot;changed&quot;: false,</span></span>
<span class="line"><span>&quot;ping&quot;: &quot;pong&quot;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>$ ansible -m ping all</span></span>
<span class="line"><span>Пример. Выполнение команды на управляемых узлах</span></span>
<span class="line"><span>$ ansible -i hosts -m shell -a &#39;uname -a&#39; servers</span></span>
<span class="line"><span>altsrv2 | CHANGED | rc=0 &gt;&gt;</span></span>
<span class="line"><span>Linux altsrv2 5.10.82-std-def-alt1 #1 SMP Fri Dec 3 14:49:25 UTC 2021 x86_64</span></span>
<span class="line"><span>GNU/Linux</span></span>
<span class="line"><span>altsrv1 | CHANGED | rc=0 &gt;&gt;</span></span>
<span class="line"><span>Linux altsrv1 5.10.82-std-def-alt1 #1 SMP Fri Dec 3 14:49:25 UTC 2021 x86_64</span></span>
<span class="line"><span>GNU/Linux</span></span>
<span class="line"><span>Пример. Удаление файла</span></span>
<span class="line"><span>$ ansible -m file -a &quot;name=/etc/nologin state=absent&quot; all</span></span>
<span class="line"><span>Цветовой вывод ansible</span></span>
<span class="line"><span>• зеленый</span></span>
<span class="line"><span>• желтый</span></span>
<span class="line"><span>• красный</span></span>
<span class="line"><span>Модули Ansible</span></span>
<span class="line"><span>О модулях</span></span>
<span class="line"><span>• Модули Ansible</span></span>
<span class="line"><span>$ ansible -m module -a &quot;name1=value1 name2=value2&quot;</span></span>
<span class="line"><span>$ ansible -i hosts -m copy -a &#39;src=/etc/hosts dst=/etc&#39; all</span></span>
<span class="line"><span>• https://docs.ansible.com</span></span>
<span class="line"><span>Часто используемые модули</span></span>
<span class="line"><span>Модуль Назначение</span></span>
<span class="line"><span>ping Проверка доступности узла</span></span>
<span class="line"><span>setup Сбор фактов с управляемых узлов</span></span>
<span class="line"><span>apt_rpm Установка/обновление ПО</span></span>
<span class="line"><span>service Управление службами</span></span>
<span class="line"><span>systemd Управление службами средствами systemd</span></span>
<span class="line"><span>copy Копирование файлов</span></span>
<span class="line"><span>file создание, удаление, изменение атрибутов</span></span>
<span class="line"><span>файлов</span></span>
<span class="line"><span>template Тиражирование шаблонных файлов</span></span>
<span class="line"><span>replace Замена строк в файлах на основе регулярных</span></span>
<span class="line"><span>выражений</span></span>
<span class="line"><span>Модуль Назначение</span></span>
<span class="line"><span>lineinfile Вставка, замена, удаление строк в файлах</span></span>
<span class="line"><span>user Управление пользовательскими УЗ</span></span>
<span class="line"><span>group Управление УЗ групп</span></span>
<span class="line"><span>command, shell Выполнение произвольных внешних команд</span></span>
<span class="line"><span>окружения</span></span>
<span class="line"><span>debug Вывод отладочной информации</span></span>
<span class="line"><span>Рецепты (плейбуки) ansible</span></span>
<span class="line"><span>О рецептах</span></span>
<span class="line"><span>Правила написания YAML-плейбуков</span></span>
<span class="line"><span>1. Отступы пробелами</span></span>
<span class="line"><span>2. Списки play, tasks</span></span>
<span class="line"><span>3. Равенство отступов</span></span>
<span class="line"><span>Структура плейбука</span></span>
<span class="line"><span>play1</span></span>
<span class="line"><span>task1</span></span>
<span class="line"><span>task2</span></span>
<span class="line"><span>. . .</span></span>
<span class="line"><span>play2</span></span>
<span class="line"><span>task1</span></span>
<span class="line"><span>task2</span></span>
<span class="line"><span>. . .</span></span>
<span class="line"><span>. . .</span></span>
<span class="line"><span>• Play (hosts-&gt;tasks)</span></span></code></pre></div></div>`,93)]))}const c=a(l,[["render",h]]);export{g as __pageData,c as default};
