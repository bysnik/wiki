Операционная система должна обеспечивать возможность создания точек восстановления (снапшотов) для последующего возвращения системы к исходному состоянию в случае сбоя. 

___

ссылка на дркументацию

Установлен Timeshift, с настройками дисков по умолчанию работает в режиме rsync

![](/public/img/createsnapshot.png)

Timeshift — программа для автоматического периодического создания копий системы (снимков/snapshots).

Timeshift предназначен прежде всего для создания снимков системных файлов и настроек. Пользовательские данные по умолчанию не архивируются поэтому в случае сбоя системы, восстанавливаются системные файлы, а данные пользователей остаются в актуальном состоянии (конечно, если они не были повреждены).

Резервные копии не могут быть восстановлены на уровне отдельных файлов, восстановление всегда происходит в полном объеме настроек Timeshift.

## Настройка резервного копирования

### Режим RSYNC

Особенности режима RSYNC:

- снимки создаются путём копирования системных файлов при помощи rsync и создания жёстких ссылок на неизмененные файлы из предыдущего снимка;
- все файлы копируются при создании первого снимка. Последующие снимки являются инкрементальными. Неизменные файлы будут связаны с предыдущим снимком, если он доступен;
- создание первого снимка может занять до 10 минут;
- системный раздел может быть отформатирован в любой файловой системе. Резервный раздел может быть отформатирован в любой файловой системе Linux, поддерживающей жесткие ссылки. Сохранение снимков на несистемный или внешний диск позволяет восстановить систему, даже если системный диск повреждён;
- можно задать исключения для файлов и каталогов для экономии дискового пространства;
- систему необходимо перезагрузить после восстановления снимка.

На вкладке «Тип» выбрать тип снимков:

[![Выбор режима RSYNC](https://www.altlinux.org/Images.www.altlinux.org/a/a4/Timeshift-rsync-01.png)](https://www.altlinux.org/%D0%A4%D0%B0%D0%B9%D0%BB:Timeshift-rsync-01.png "Выбор режима RSYNC")

Снимки имеют большой размер, поэтому желательно хранить их на другом диске или разделе. По умолчанию снимки сохраняются в системном (корневом) разделе в /timeshift, также можно выбрать другие разделы Linux.

На вкладке «Место» можно выбрать место, где будут храниться снимки:

[![Выбор расположения снимков RSYNC](https://www.altlinux.org/Images.www.altlinux.org/c/ca/Timeshift-rsync-02.png)](https://www.altlinux.org/%D0%A4%D0%B0%D0%B9%D0%BB:Timeshift-rsync-02.png "Выбор расположения снимков RSYNC")

На вкладке «Расписание» можно выбрать несколько уровней создания снимков (ежемесячно, еженедельно, ежедневно, ежечасно, при загрузке) и указать количество сохраняемых снимков для каждого уровня:

[![Расписание для снимков RSYNC](https://www.altlinux.org/Images.www.altlinux.org/f/f0/Timeshift-rsync-03.png)](https://www.altlinux.org/%D0%A4%D0%B0%D0%B9%D0%BB:Timeshift-rsync-03.png "Расписание для снимков RSYNC")

Снимки уровня «Загрузка» создаются при каждом запуске системы (с задержкой в 10 минут). Они выполняются в фоне и не влияют на скорость загрузки системы.

На вкладке «Пользователи» можно указать, включать ли в резервную копию пользовательские данные.

Т.к. Timeshift не предназначен для резервного копирования пользовательских данных, по умолчанию домашние каталоги пользователей не включаются в резервную копию. Это сделано для предотвращения перезаписи пользовательских данных во время восстановления, а также для уменьшения размера резервных копий.

Если выбрать опцию «Включить только скрытые файлы», будет выполнено резервное копирование и восстановление скрытых файлов и каталогов в домашнем каталоге пользователя (эти каталоги содержат пользовательские файлы конфигурации):

[![Вкладка «Пользователи»](https://www.altlinux.org/Images.www.altlinux.org/9/9b/Timeshift-rsync-04.png)](https://www.altlinux.org/%D0%A4%D0%B0%D0%B9%D0%BB:Timeshift-rsync-04.png "Вкладка «Пользователи»")

На вкладке «Фильтры» можно выборочно указать, какие файлы/каталоги включать/исключать из резервного копирования (динамические каталоги исключаются по умолчанию: /dev, /proc, …):

[![Вкладка «Фильтры»](https://www.altlinux.org/Images.www.altlinux.org/8/88/Timeshift-rsync-05.png)](https://www.altlinux.org/%D0%A4%D0%B0%D0%B9%D0%BB:Timeshift-rsync-05.png "Вкладка «Фильтры»")

В данном примере из резервного копирования будут исключены все файлы mp3, все системные журналы, кроме журналов веб-сервера apache.

Редактировать шаблон можно дважды щелкнув левой кнопкой мыши по строке шаблона.

**Примечание:** При переборе шаблонов, срабатывает первое правило под которое подпадает текущий путь.

- '*' в шаблоне соответствует любому компоненту пути кроме "/";
- '**' в шаблоне соответствует любому компоненту пути, включая "/".

Например:

- /mydir/ — каталог mydir (но не его содержимое);
- /mydir/* — все файлы и каталоги в mydir (но не содержимое вложенных каталогов);
- /mydir/** — все файлы и каталоги в mydir (включая содержимое вложенных каталогов, рекурсивно);
- /mydir/*** — соответствует как каталогу mydir (как если бы было указано «/mydir/»), так и всему содержимому этого каталога (как если бы было указано «/mydir/**»).

Для того чтобы исключить из снимка содержимое каталога, но сам каталог оставить, нужно указать в шаблоне '/mydir/**', а не '/mydir/' (для каталога указание "/" в конце обязательно).

Шаблон не начинающийся с '/' проверяется с конца строки.

Если шаблон начинается на "+", то он рассматривается как включающий шаблон.

Подробнее см. **man rsync**.

  

**Примечание:** Не рекомендуется включать пользовательские данные в резервные копии, так как они будут перезаписаны при восстановлении снимка.

  
Просмотреть итоговый список исключений можно, нажав кнопку «Итог» на вкладке «Фильтры»:

[![Итоговый список исключений](https://www.altlinux.org/Images.www.altlinux.org/9/93/Timeshift-rsync-06.png)](https://www.altlinux.org/%D0%A4%D0%B0%D0%B9%D0%BB:Timeshift-rsync-06.png "Итоговый список исключений")

### Режим BTRFS

Особенности режима BTRFS:

- снимки создаются с использованием встроенных средств файловой системы BTRFS;
- снимки создаются и восстанавливаются мгновенно (создание снимков — это атомарная транзакция на уровне файловой системы);
- снимки восстанавливаются путём замены системных подразделов. Поскольку файлы никогда не копируются, не удаляются и не перезаписываются, риск потери данных отсутствует. Существующая система сохраняется как новый снимок после восстановления;
- снимки сохраняются на том же диске, с которого они созданы (системном диске). Хранение на других дисках не поддерживается. Если системный диск выйдет из строя, снимки, хранящиеся на нём, будут потеряны вместе с системой;
- нет возможности исключать файлы и каталоги;
- размер снимков BTRFS изначально равен нулю. При изменении системных файлов, данные записываются в новые блоки данных, которые занимают дисковое пространство (копирование при записи). Файлы в снимке продолжают указывать на исходные блоки данных;
- ОС должна быть установлена на раздел BTRFS с разбивкой на подразделы @ и @home (см. [Btrfs](https://www.altlinux.org/Btrfs "Btrfs")). Другие виды разделов не поддерживаются;
- снимки можно восстановить без немедленной перезагрузки запущенной системы.

На вкладке «Тип» выбрать тип снимков:

[![Выбор режима BTRFS](https://www.altlinux.org/Images.www.altlinux.org/e/e1/Timeshift-btrfs-01.png)](https://www.altlinux.org/%D0%A4%D0%B0%D0%B9%D0%BB:Timeshift-btrfs-01.png "Выбор режима BTRFS")

Настоятельно рекомендуется использовать моментальные снимки BTRFS в системах, установленных в разделе BTRFS.

  
На вкладке «Место» указать устройство, где будут храниться снимки:

[![Выбор расположения снимков BTRFS](https://www.altlinux.org/Images.www.altlinux.org/c/c5/Timeshift-btrfs-02.png)](https://www.altlinux.org/%D0%A4%D0%B0%D0%B9%D0%BB:Timeshift-btrfs-02.png "Выбор расположения снимков BTRFS")

На вкладке «Расписание» можно выбрать несколько уровней создания снимков (ежемесячно, еженедельно, ежедневно, ежечасно, при загрузке) и указать количество сохраняемых снимков для каждого уровня:

[![Расписание для снимков BTRFS](https://www.altlinux.org/Images.www.altlinux.org/4/40/Timeshift-btrfs-03.png)](https://www.altlinux.org/%D0%A4%D0%B0%D0%B9%D0%BB:Timeshift-btrfs-03.png "Расписание для снимков BTRFS")

Снимки уровня «Загрузка» создаются при каждом запуске системы (с задержкой в 10 минут). Они выполняются в фоне и не влияют на скорость загрузки системы.

Т.к. Timeshift не предназначен для резервного копирования пользовательских данных, по умолчанию домашние каталоги пользователей не включаются в резервную копию. На вкладке «Пользователи» можно включить подраздел @home в создаваемые снимки:

[![Домашние каталоги пользователей BTRFS](https://www.altlinux.org/Images.www.altlinux.org/a/a4/Timeshift-btrfs-04.png)](https://www.altlinux.org/%D0%A4%D0%B0%D0%B9%D0%BB:Timeshift-btrfs-04.png "Домашние каталоги пользователей BTRFS")