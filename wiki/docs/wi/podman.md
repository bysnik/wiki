# Podman

![](https://basis.gnulinux.pro/ru/latest/_images/podman.png)

Podman – это инструмент с открытым исходным кодом для поиска, сборки, передачи и запуска приложений. Является утилитой командной строки с аналогичными docker командами, однако не требует дополнительный сервис для работы и может работать без прав доступа root. По умолчанию использует в качестве Container Runtime crun (ранее runc).

Возможность работать с контейнерами без прав root приводит к нескольким особенностям:
- все файлы Podman (образы, контейнеры и др.) пользователей с правами доступа root хранятся в каталоге `/var/lib/containers`, без прав доступа root – в `~/.local/share/containers`
- пользователи без root прав по умолчанию не могут использовать привилегированные порты и полноценно использовать некоторые команды

## Установка Podman

```bash
apt-get install podman podman-compose
```

Если Вам нужен Docker-совместимый сокет (например, для Docker CLI или других инструментов), включите службу:
```bash
systemctl enable --now podman.socket
```

Для rootless (пользовательский режим):
```bash
systemctl --user enable --now podman.socket
```

## Rootless режим

Для использования podman непривилегированными пользователями, необходимо произвести ряд дополнительных действий по настройке прав:

Проверить наличие разрешения на создание пользовательских пространств имён:
```bash
sysctl kernel.unprivileged_userns_clone
```
Если отсутствует, то разрешаем (устанавливаем пакет с необходимой конфигурацией)
```bash
apt-get install sysctl-conf-userns
```
Предоставить права на запуск исполняемых файлов `/usr/bin/newuidmap` и `/usr/bin/newgidmap` пользователям, не являющимся владельцами файла и не принадлежащим к группе владельца файла:
```bash
control newgidmap public
control newuidmap public
```
Поскольку эти исполняемые файлы обращаются к системным вызовам `setuid()` и `setgid()`, чтобы лишний раз не выдавать SUID бит, задайте этим файлам соответствующие file capabilities:
```bash
setcap cap_setuid+ep /usr/bin/newuidmap
setcap cap_setgid+ep /usr/bin/newgidmap
```
Если при попытке работы с podman под непривилегированным пользователем (например, `"$ podman images"`) выдаётся ошибка `"Error: kernel does not support overlay fs: 'overlay' is not supported ..."`, то нужно донастроить `Fuse`:

Под пользователем root:
```bash
apt-get install fuse-overlayfs
control fusermount fuseonly
usermod -aG fuse <your_unprivileged_user_here>
```
Далее нужно перезайти под непривилегированным пользователем и проверить, что нет ошибок - вывод должен быть примерно такого вида:
```bash
$ fusermount -V
# fusermount version: 2.9.9
$ fusermount3 -V
# fusermount3 version: 3.16.2
```
Этих действий достаточно для запуска podman непривилегированными пользователями. 

::: tip Примечание:

Чтобы podman могли запускать непривилегированные пользователи, для каждого такого пользователя должна существовать запись конфигурации subuid и subgid. Новые пользователи, созданные после установки podman, имеют эти записи по умолчанию.

Для пользователей, у которых нет записей в `/etc/subuid` и `/etc/subgid`, можно создать запись с помощью команды `usermod`, например:
```bash
usermod --add-subuids 100000-165535 --add-subgids 100000-165535 имя_пользователя
```
Данная команда выделяет заданный диапазон UID и GID пользователю, что позволит пользователю и группе с именем пользователя запускать контейнеры Podman.

В случае попытки добавить доменного пользователя, имя пользователя вносится в `/etc/subuid` и `/etc/subgid` вручную.

Указанный выше диапазон UID и GID уже может быть занят другим пользователем, т.к. это диапазон по умолчанию для первого пользователя. Просмотреть занятые диапазоны можно в файлах `/etc/subuid` и `/etc/subgid`, например:
```bash
cat /etc/subuid 
# user:100000:65536
# user2:165536:65536
```
Многим образам требуется 65536 uid/gid для сопоставления. Рекомендуется выделять как минимум столько uid/gid для каждого пользователя.

Для применения изменений в `subuid` и `subgid` необходимо выполнить команду:
```bash
$ podman system migrate
```
:::

## Запуск образов

Podman предоставляет совместимый с Docker интерфейс CLI, а следовательно допустимо настроить при необходимости `alias docker=podman`:
```bash
echo "alias docker=podman" >> ~/.bashrc
```
Загрузка образа из репозитория:
```bash
podman pull registry.altlinux.org/alt/alt
```
Запуск контейнера из образа:
```bash
podman run -it --name alt registry.altlinux.org/alt/alt
```